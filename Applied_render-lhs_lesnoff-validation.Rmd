---
title: "Lesnoff_validation"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup}

applied_example <- F
local <- T

############
## SETUP ##
############

# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc.R")) # wrapper function
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac.R")) # flock dynamics model function
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac
```


```{r loadpars}
## Load parameters
datafile <- "-lesnoff_validation"
source(paste0(filepath, "scripts/applied/applied_load_data2.R")) 
lesnoff_target <- read_csv("data/Applied_parameters/target-lesnoff_validation.csv", col_names = T)


## Datasets
datasets <- fix_age_data_full %>% select(-c(parameter)) %>% colnames()
```
# Set up Global Model Options:

```{r modsetup}
######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 2*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## MODEL INPUTS ##
##################

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


lhs <- T
lhs_n <- 1e4 # number of sets (parameter combinations)
pairs_plot <- F
SA <- TRUE

```

## Model Offtake Only

- Run model with all demographic processes set to 0 except offtake rates

```{r Alloff_target}

################
## MOD OUTPUT ##
################

output <- "off_only" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

##################################
## LHS DEMOGRAPHIC PARS ##
##################################
dataset <- "lesnoff.off"
data_filename <- gsub("\\.","",dataset)

# set seed
set.seed(1) # so that results are consistent

pars_min <- paste0(dataset, ".min") # minimum val
pars_max <-  paste0(dataset, ".max") # maximum val
fixdata <- dataset # set dataset for state_vars
vardata <- dataset


source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

# Format demographic parameter sets:
var_input_off <- var_input_df %>% as.data.frame()

outOff <- c()


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
outOff <- foreach (i = 1:nrow(var_input_off), 
                   .combine = "rbind",
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_off[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

stopCluster(cl)

```

- First look at ranges of input nad output parameters:
```{r offRanges}

# First look at ouptut:

# calculate fortnightly rates: 
OutOff <- as.data.frame(outOff) %>%
    mutate(set = 1:nrow(.)) %>%
    select(set, offF012, offF12end, offM06, offM6end, offF, offM) %>%
  mutate(
    offF012ft = 1 - ((1 - offF012) ^ (1 / 26)),
    offF12endft = 1 - ((1 - offF12end) ^ (1 / 26)),
    offM06ft = 1 - ((1 - offM06) ^ (1 / 26)),
    offM6endft = 1 - ((1 - offM6end) ^ (1 / 26)),
    offFft = 1 - ((1 - offF) ^ (1 / 26)),
    offMft = 1 - ((1 - offM) ^ (1 / 26))
  )

outOff_long <- OutOff %>% 
  as.data.frame() %>%
  select(offF012ft, offF12endft, offM06ft, offM6endft, offFft, offMft) %>%
  gather(key = "par", value = "offtake") %>%
  mutate(par = factor(par, levels = c("offF012ft", "offF12endft", "offM06ft", "offM6endft", "offFft", "offMft")),
         par2 = gsub("ft","", par))

# outOff_boxplot <- ggplot(outOff_long,aes(x=par, y=offtake))+
#   geom_boxplot()+
#   labs(x="Age Group", y = "Offtake Rate (Annual)", title = "Model Output: Offtake Rate Ranges")

lesnoff_target_ranges <- lesnoff_target %>% 
  gather(key = "target", value = "value", -parameter) %>%
  mutate(target = gsub("\\.min*|\\.max*","", target))

lesnoff_targetOff_ranges <- lesnoff_target_ranges %>% filter(grepl("off",parameter))

ggplot(outOff_long, aes(x=par2, y=offtake))+
  geom_boxplot()+
  geom_line(data = lesnoff_targetOff_ranges, 
            aes(x=parameter, y=value, col = target), 
            size = 1,
            position = position_dodge(width = 0.5))+
  labs(x="Age Group", y = "Offtake Rate (Annual)", title = "Model Output: Offtake Rate Ranges")

```


- Calculate which simulations produce offtake rates within the range specified by Lesnoff papers

```{r offAnalysis2}
# Use target demographic ranges based on min-max ranges;
# +/- 10%, 20% does not produce viable results.
# min-max based on seasonal range produces viable results
# min-max based on all female and all male offtake produces viable results.

rateMin <- "lesnoff.targ.min20"
rateMax <-  "lesnoff.targ.max20"
  
# female mortality <12m target
F1targ_min <- lesnoff_target %>% filter(parameter == "offF012") %>% select(all_of(`rateMin`)) %>% pull()
F1targ_max <- lesnoff_target %>% filter(parameter == "offF012") %>% select(all_of(`rateMax`)) %>% pull()

F2targ_min <- lesnoff_target %>% filter(parameter == "offF12end") %>% select(all_of(`rateMin`)) %>% pull()
F2targ_max <- lesnoff_target %>% filter(parameter == "offF12end") %>% select(all_of(`rateMax`)) %>% pull()

# Male mort <6m target
M1targ_min <- lesnoff_target %>% filter(parameter == "offM06") %>% select(all_of(`rateMin`)) %>% pull()
M1targ_max <- lesnoff_target %>% filter(parameter == "offM06") %>% select(all_of(`rateMax`)) %>% pull()

M2targ_min <- lesnoff_target %>% filter(parameter == "offM6end") %>% select(all_of(`rateMin`)) %>% pull()
M2targ_max <- lesnoff_target %>% filter(parameter == "offM6end") %>% select(all_of(`rateMax`)) %>% pull()

offTarg <- OutOff %>% 
  mutate(offF1_targ = ifelse(offF012ft>=F1targ_min & offF012ft<=F1targ_max, 1, 0),
         offF2_targ = ifelse(offF12endft>=F2targ_min & offF12endft<=F2targ_max, 1, 0),
         offM1_targ = ifelse(offM06ft>=M1targ_min & offM06ft<=M1targ_max, 1, 0),
         offM2_targ = ifelse(offM6endft>=M2targ_min & offM6endft<=M2targ_max, 1, 0)) %>%
  mutate(targSum = apply(.[14:17],1,sum))

offTarg %>% 
  filter(targSum == 3) %>% 
  select(ends_with("ft"), -c(offFft, offMft) ) %>% 
  gather(key = "par", value = "offtake") %>% 
  mutate(par2 = gsub("ft","", par)) %>% 
  ggplot(aes(x=par2, y = offtake))+
  geom_point()+
  geom_line(data = lesnoff_targetOff_ranges, 
            aes(x=parameter, y=value, col = target), 
            size = 1,
            position = position_dodge(width = 0.5))

offTarg %>% 
  filter(targSum == 3) %>% 
  select(ends_with("ft"), -c(offFft, offMft) ) %>% 
  pairs()


if(length(which(offTarg$targSum==4))>0){
  
  offTarg %>% 
  filter(targSum == 4) %>% 
  select(ends_with("ft")) %>% gather(key = "group", value = "value") %>% 
  ggplot(aes(x=group, y = value))+geom_point()
  
 offValidIDs <- offTarg %>% filter(targSum==4) %>% pull(set)
  offValidPars <- var_input_backup[offValidIDs, ] %>% 
  select(contains("offtake"))
  pairs(offValidPars)
}



## RELAXED PARAMETERS ##


rateMin <- "lesnoff.targ.minMF"
rateMax <-  "lesnoff.targ.maxMF"

OutOffAll <- as.data.frame(outOff) %>%
    mutate(set = 1:nrow(.)) %>%
    select(set, offF, offM) %>%
  mutate(
    offFft = 1 - ((1 - offF) ^ (1 / 26)),
    offMft = 1 - ((1 - offM) ^ (1 / 26))
  )
  
# female mortality All target
Ftarg_min <- lesnoff_target %>% filter(parameter == "offF") %>% select(all_of(`rateMin`)) %>% pull()
Ftarg_max <- lesnoff_target %>% filter(parameter == "offF") %>% select(all_of(`rateMax`)) %>% pull()

# male mortality All target
Mtarg_min <- lesnoff_target %>% filter(parameter == "offM") %>% select(all_of(`rateMin`)) %>% pull()
Mtarg_max <- lesnoff_target %>% filter(parameter == "offM") %>% select(all_of(`rateMax`)) %>% pull()


offTargAll <- OutOffAll %>% 
  mutate(offF_targ = ifelse(offFft>=Ftarg_min & offFft<=Ftarg_max, 1, 0),
         offM_targ = ifelse(offMft>=Mtarg_min & offMft<=Mtarg_max, 1, 0)) %>%
  mutate(targSum = apply(.[6:7],1,sum))


offTargAll %>% filter(targSum == 2) %>% 
  select(ends_with("ft")) %>% 
  gather(key = "group", value = "value") %>% 
  ggplot(aes(x=group, y = value))+geom_point()

if(length(which(offTargAll$targSum==2))>0){
 offAllValidIDs <- offTargAll %>% filter(targSum==2) %>% pull(set)
 offAllValidPars <- var_input_backup[offAllValidIDs, ] %>% 
  select(contains("offtake"))
}

pairs(offAllValidPars)

```

## ALL Mortality Rates

```{r mortMod}

## Model Output
output <- "mort_only" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)

##################################
## LHS DEMOGRAPHIC PARS ##
##################################
dataset <- "lesnoff.mort"
data_filename <- gsub("\\.","",dataset)

# set seed
set.seed(1) # so that results are consistent

pars_min <- paste0(dataset, ".min") # minimum val
pars_max <-  paste0(dataset, ".max") # maximum val
fixdata <- dataset # set dataset for state_vars
vardata <- dataset


source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

# Format demographic parameter sets:
var_input_backup <- var_input_df %>% as.data.frame()

outMort <- c()


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
outMort <- foreach (i = 1:nrow(var_input_backup), 
                   .combine = "rbind",
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

stopCluster(cl)

```

```{r mortAnalysis}

# select min and max data: (+/- 10, 15, 20%, or Seasonal)

rateMin <- "lesnoff.targ.min10"
rateMax <-  "lesnoff.targ.max10"

OutMort <- as.data.frame(outMort) %>%
    mutate(set = 1:nrow(.)) %>%
    select(set, mortF012, mortF12end, mortM06, mortM6end) %>%
  mutate(
    mortF012ft = 1 - ((1 - mortF012) ^ (1 / 26)),
    mortF12endft = 1 - ((1 - mortF12end) ^ (1 / 26)),
    mortM06ft = 1 - ((1 - mortM06) ^ (1 / 26)),
    mortM6endft = 1 - ((1 - mortM6end) ^ (1 / 26))
  )
  
# female mortality <12m target
F1targ_min <- lesnoff_target %>% filter(parameter == "mortF012") %>% select(all_of(`rateMin`)) %>% pull()
F1targ_max <- lesnoff_target %>% filter(parameter == "mortF012") %>% select(all_of(`rateMax`)) %>% pull()

F2targ_min <- lesnoff_target %>% filter(parameter == "mortF12end") %>% select(all_of(`rateMin`)) %>% pull()
F2targ_max <- lesnoff_target %>% filter(parameter == "mortF12end") %>% select(all_of(`rateMax`)) %>% pull()

# Male mort <6m target
M1targ_min <- lesnoff_target %>% filter(parameter == "mortM06") %>% select(all_of(`rateMin`)) %>% pull()
M1targ_max <- lesnoff_target %>% filter(parameter == "mortM06") %>% select(all_of(`rateMax`)) %>% pull()

M2targ_min <- lesnoff_target %>% filter(parameter == "mortM6end") %>% select(all_of(`rateMin`)) %>% pull()
M2targ_max <- lesnoff_target %>% filter(parameter == "mortM6end") %>% select(all_of(`rateMax`)) %>% pull()


mortTarg <- OutMort %>% 
  mutate(mortF1_targ = ifelse(mortF012ft>=F1targ_min & mortF012ft<=F1targ_max, 1, 0),
         mortF2_targ = ifelse(mortF12endft>=F2targ_min & mortF12endft<=F2targ_max, 1, 0),
         mortM1_targ = ifelse(mortM06ft>=M1targ_min & mortM06ft<=M1targ_max, 1, 0),
         mortM2_targ = ifelse(mortM6endft>=M2targ_min & mortM6endft<=M2targ_max, 1, 0)) %>%
  mutate(targSum = apply(.[10:13],1,sum))

length(which(mortTarg$targSum==2))

mortTarg %>% filter(targSum == 3) %>% select(ends_with("ft")) %>% gather(key = "group", value = "value") %>% 
  ggplot(aes(x=group, y = value))+geom_point()

mortTarg %>% filter(targSum == 4) %>% select(ends_with("ft")) %>% gather(key = "group", value = "value") %>% 
  ggplot(aes(x=group, y = value))+geom_point()

if(length(which(mortTarg$targSum==4))>0){
 mortValidIDs <- mortTarg %>% filter(targSum==4) %>% pull(set)
mortValidPars <- var_input_backup[mortValidIDs, ] %>% 
  select(contains("mortality"))
}

pairs(mortValidPars)



rateMin <- "lesnoff.targ.minMF"
rateMax <-  "lesnoff.targ.maxMF"

OutMortAll <- as.data.frame(outMort) %>%
    mutate(set = 1:nrow(.)) %>%
    select(set, mortF, mortM) %>%
  mutate(
    mortFft = 1 - ((1 - mortF) ^ (1 / 26)),
    mortMft = 1 - ((1 - mortM) ^ (1 / 26))
  )
  
# female mortality All target
Ftarg_min <- lesnoff_target %>% filter(parameter == "mortF") %>% select(all_of(`rateMin`)) %>% pull()
Ftarg_max <- lesnoff_target %>% filter(parameter == "mortF") %>% select(all_of(`rateMax`)) %>% pull()

# male mortality All target
Mtarg_min <- lesnoff_target %>% filter(parameter == "mortM") %>% select(all_of(`rateMin`)) %>% pull()
Mtarg_max <- lesnoff_target %>% filter(parameter == "mortM") %>% select(all_of(`rateMax`)) %>% pull()


mortTargAll <- OutMortAll %>% 
  mutate(mortF_targ = ifelse(mortFft>=Ftarg_min & mortFft<=Ftarg_max, 1, 0),
         mortM_targ = ifelse(mortMft>=Mtarg_min & mortMft<=Mtarg_max, 1, 0)) %>%
  mutate(targSum = apply(.[6:7],1,sum))

length(which(mortTargAll$targSum==2))

mortTargAll %>% filter(targSum == 2) %>% select(ends_with("ft")) %>% gather(key = "group", value = "value") %>% 
  ggplot(aes(x=group, y = value))+geom_point()

if(length(which(mortTargAll$targSum==2))>0){
 mortAllValidIDs <- mortTargAll %>% filter(targSum==2) %>% pull(set)
 mortAllValidPars <- var_input_backup[mortAllValidIDs, ] %>% 
  select(contains("mortality"))
}

pairs(mortAllValidPars)

```


## Biological / Field relevance of parameter combinations

```{r biorelevance}

offtakeValid <- offValidPars %>% filter(NET_offtake_m2>NET_offtake_f, 
                                          NET_offtake_f>=NET_offtake_y)

offValidPars_long <- offValidPars %>% 
  select(-min_age_offtake) %>%
  gather(key = "par", val = "off")

# boxplot before filtering conditions: 
ggplot(offValidPars_long, 
       aes(x = par, y = off))+
  geom_boxplot()+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))




# create dataframe of valid mortality parameters with datasource (profile) included
# use dataframe to filter results, checking against realistic biological/field observations
# mortality_y (youth mortality) should be higher than mortality_a (adult mortality)

mortalityValid <- mortValidPars %>% filter(mortality_y>mortality_a)

mortValidPars_long <- mortValidPars %>%
  gather(key = "par", val = "mort")

# boxplot before filtering conditions: 
ggplot(mortValidPars_long, 
       aes(x = par, y = mort))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))

```

## Valid parameter combinations?
```{r validTest}
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y

lhs <- T
lhs_n <- 1e4 # number of sets (parameter combinations)
pairs_plot <- F
SA <- TRUE

mortalityValid <- mortalityValid %>%
  mutate(id = 1:nrow(mortalityValid))

mortIds <- data.frame(id = sample(1:nrow(mortalityValid), size = lhs_n, replace = T))

mortalityValid_join <- left_join(mortIds, 
                                 mortalityValid, 
                                 by = "id") %>%
  as.data.frame() %>% 
  select(-id)


offtakeValid <- offtakeValid %>%
  mutate(id = 1:nrow(offtakeValid))

offIds <- data.frame(id = sample(1:nrow(offtakeValid), size = lhs_n, replace = T))

offtakeValid_join <- left_join(offIds,
                           offtakeValid,
                           by = "id") %>%
  as.data.frame() %>% 
  select(-c(id, min_age_offtake))


###########################
##        MODEL          ##
###########################
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## MODEL INPUTS ##
##################

## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## LHS DEMOGRAPHIC PARS ##
##################################
dataset <- "lesnoff.test"
data_filename <- gsub("\\.","",dataset)

# set seed
set.seed(1) # so that results are consistent

pars_min <- paste0(dataset, ".min") # minimum val
pars_max <-  paste0(dataset, ".max") # maximum val
fixdata <- dataset # set dataset for state_vars
vardata <- dataset


source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

# Format demographic parameter sets:
var_input_backup <- var_input_df %>% 
  as.data.frame() %>%
  select(birth_rate, adu_f_max_yrs, adu_m_max_yrs,min_age_offtake,min_age_repro) %>%
  bind_cols(mortalityValid_join,
        offtakeValid_join)

out <- c()


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
out <- foreach (i = 1:nrow(var_input_backup), 
                   .combine = "rbind",
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

stopCluster(cl)















```



```{r lesnoffInput}

# exclude mortality where young mortality is very high
valid_offFM_test <- valid_offFM_df %>% filter(NET_offtake_y < NET_offtake_f)
valid_mortFM_df 

# Use valid offtake and mortality parameters to produce dataframe of parameter inputs for lesnoff testing
# var_input_lesnoff <- valid_mortFM_df %>%
#   cbind(valid_offFM_test %>% slice(rep(1:n(), each = nrow(valid_mortFM_df))))
# 
# setdiff(colnames(var_input_backup),colnames(var_input_lesnoff))
# 
# var_input_lesnoff <- var_input_lesnoff %>%
#   mutate("adu_f_max_yrs" = 9,
#          "adu_m_max_yrs" = 4,
#          "min_age_offtake" = 6,
#          "min_age_repro" = 9, 
#          "birth_rate" = 0.9365096)
# 
# write.csv(var_input_lesnoff, file = "data/Applied_parameters/demographics-lesnoff_input.csv", row.names = F)

var_input_lesnoff <- read_csv("data/Applied_parameters/demographics-lesnoff_input.csv")

```


```{r lesnoffMod}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## MODEL INPUTS ##
##################

## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## LHS DEMOGRAPHIC PARS ##
##################################

dataset <- "lesnoff.yr" # for selecting state_vars input data
data_filename <- gsub("\\.","",dataset)

lhs <- T
# lhs_n <- 1 # number of sets (parameter combinations)
# pairs_plot <- F
# SA <- TRUE
# 
# # set seed
# set.seed(1) # so that results are consistent
# 
# pars_min <- paste0(dataset, ".min") # minimum val
# pars_max <-  paste0(dataset, ".max") # maximum val
# fixdata <- dataset # set dataset for state_vars
# vardata <- dataset
# 
# 
# source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

# Format demographic parameter sets:
var_input_backup <- var_input_lesnoff %>% as.data.frame()

Out_lesnoff <- c()


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
Out_lesnoff <- foreach (i = 1:nrow(var_input_backup), 
                .packages = c("dplyr", "tibble"),
                .combine = "rbind"
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

stopCluster(cl)

```

```{r lesnoffGrowth}

# Out_lesnoff is a dataframe of summary data for each parameter set "valid" parameter set

## Plot population growth stats: 
# - Total Growth (20y), 
# - Midyr Growth (10y), 
# - Finyr Growth (1y)

## POPULATION GROWTH ## 

# Long dataframe:
popgrowth <- Out_lesnoff %>% 
  select(ends_with("growth")) %>% 
  gather(key = "par", value = "prop") %>% 
  mutate(par = factor(par, levels = c("finyr_growth","twoyr_growth", "tenyr_growth", "pop_growth")))

Out_lesnoff %>% select(ends_with("growth")) %>% summary()

# Boxplot of growth statistics:
growth_summplot <- ggplot(popgrowth, aes(x=par, y = prop))+
  geom_boxplot()+
  facet_wrap(~par, scales = "free_x", nrow = 1)+
  labs(x = "Growth Stat", 
       y = "Pop Growth",
       title = "Growth statistics for Lesnoff data, LHS parameter sets")+
  theme_bw()

growth_summplot

# Boxplot of Final year growth: 
finyr_summplot <- ggplot(Out_lesnoff, aes(finyr_growth))+
  geom_histogram(colour = "black",
                 alpha = 0.5)+
  geom_vline(xintercept = 1)+
  labs(x="Final year growth", 
       y = "Count", 
       title = "Distribution of final year growth, Lesnoff, (LHS parameter sets)")+
  theme_bw()

finyr_summplot


## AGE-SEX DYNAMICS ##

# Long dataframe:
agesex <- Out %>% 
  select(starts_with("pf"), starts_with("pm")) %>% 
  gather(key = "par", value = "prop")

# Boxplot of stable age-sex structure:
agesex_summplot <- ggplot(agesex, aes(x=par, y = prop))+
  geom_boxplot(fill = "grey", 
               alpha = 0.5)+
  labs(x="Age-Sex Group", 
       y = "Proportion",
       title = "Stable Age-Sex structure, Lesnoff, (LHS parameter sets)")+
  theme_bw()
  
agesex_summplot
agesex %>% group_by(par) %>% summarise(meanprop = mean(prop)) %>% kable()

# All growth plots:
ggarrange(growth_summplot, finyr_summplot, agesex_summplot, ncol = 1)

```

```{r lesnoffOutValid}

#------------------------------------------------------------------------------
## VALID RESULTS ##

##################################
## Valid Age-Sex Conditions ##
##################################

## Min and max proportions for each sex-age group (see age-sex SS)
pfKid.min <- 0.05; pfKid.max <- 0.19
pfSub.min <- 0.06; pfSub.max <- 0.19
pfAdu.min <- 0.21; pfAdu.max <- 0.62

pmKid.min <- 0.05; pmKid.max <- 0.16
pmSub.min <- 0.04; pmSub.max <- 0.15
pmAdu.min <- 0.01; pmAdu.max <- 0.15
  

#########################################################
# Retain behavioral parameter sets
#########################################################

# add set id to output df:
Out_lesnoff <- Out_lesnoff %>%
  mutate(set = 1:nrow(Out_lesnoff), 
         midyr_growth = tenyr_growth)

# Edit Out to contain identifier variables for pop growth (5%,15%) and pop growth with age-sex structure 
Out_ext <- Out_lesnoff %>%
  mutate(midyr_growth = replace_na(midyr_growth, 0),
         # add variables to identify parameter sets with growth between 5% and 15%
         midyr_15 = ifelse(midyr_growth>=0.85 & midyr_growth <=1.15, 1, 0),
         midyr_05 = ifelse(midyr_growth>=0.95 & midyr_growth <=1.05, 1, 0)) %>%
  
  # add variables to identify parameter sets with growth between 5% and 15% AND age-sex conditions
  mutate(
    midyr_15age = ifelse(
      midyr_15 == 1 &
        pfKid >= pfKid.min & pfKid <= pfKid.max &
        pfSub >= pfSub.min & pfSub <= pfSub.max &
        pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
        
        pmKid >= pmKid.min & pmKid <= pmKid.max &
        pmSub >= pmSub.min & pmSub <= pmSub.max &
        pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0),
    
    midyr_05age = ifelse(
      midyr_05 == 1 &
        pfKid >= pfKid.min & pfKid <= pfKid.max &
        pfSub >= pfSub.min & pfSub <= pfSub.max &
        pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
        
        pmKid >= pmKid.min & pmKid <= pmKid.max &
        pmSub >= pmSub.min & pmSub <= pmSub.max &
        pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0)
  )

Out_ext %>% group_by(midyr_15age, midyr_05age) %>% count() %>% kable()

##################
## Valid Output ##
##################

Out_valid <- Out_ext %>%
  filter(midyr_15age == 1 |
           midyr_05age == 1)

## Refine parameter dataframe:
Out_parameters <- var_input_backup %>%
  mutate(set = 1:nrow(var_input_backup)) %>%
  left_join(Out_ext %>%
              select(midyr_growth,
                     midyr_15,
                     midyr_05,
                     midyr_15age,
                     midyr_05age,
                     set), by = c("set"))

pars_valid <- Out_parameters %>% 
  filter(midyr_15age == 1 |
           midyr_05age == 1)  %>%
  select(-c(midyr_15,
            midyr_05,
            set))

library(GGally)
pairs(pars_valid %>% select(-c(midyr_growth,midyr_05age,midyr_15age)))

```


```{r lesnoffMod}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 10*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## MODEL INPUTS ##
##################

## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## LHS DEMOGRAPHIC PARS ##
##################################

dataset <- "lesnoff.yr" # for selecting state_vars input data
data_filename <- gsub("\\.","",dataset)

lhs <- T
# lhs_n <- 1 # number of sets (parameter combinations)
# pairs_plot <- F
# SA <- TRUE
# 
# # set seed
# set.seed(1) # so that results are consistent
# 
# pars_min <- paste0(dataset, ".min") # minimum val
# pars_max <-  paste0(dataset, ".max") # maximum val
# fixdata <- dataset # set dataset for state_vars
# vardata <- dataset
# 
# 
# source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

# Format demographic parameter sets:
var_input_backup <- var_input_lesnoff %>% as.data.frame()

Out_lesnoffDyn <- c()


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
Out_lesnoffDyn <- foreach (i = 1:nrow(var_input_backup), 
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

stopCluster(cl)

```


```{r}


################################
## POP & AGE-SEX DYNAMICS ##
################################

# Out is a list of df which track full population dynamics for 1000 (lhs_n) parameter combinations over 20y periods

# Sample for plotting
dyn_sample <- sample(1:nrow(var_input_lesnoff), 10, replace = F)

# Transform Out (list) into a df of dynamics with each set identified:
Out_dynamics <- Out_lesnoffDyn %>%
  do.call(rbind, .) %>% 
  mutate(set = rep(1:nrow(var_input_lesnoff), each = TimeStop_dynamics))

# Population Growth plot:
growth_dynplot <- ggplot(Out_dynamics, 
       aes(x = w, y = sum_pop, group = set)) + 
  labs(x="weeks", 
       y = "Population Size",
       title = "Population growth over 10 years, Lesnoff, (LHS Valid Sets)")+
  geom_line()+
  theme_bw()

# AgeSex Dynamics df: 
Out_agesex <- Out_dynamics %>% 
  select(c("w", "set", starts_with("pf"), starts_with("pm"))) %>% 
  gather(key = "par", value = value, -c(w,set)) %>%
  mutate(par = factor(par, levels = c("pfAdu", "pfSub", "pfKid", 
                                         "pmAdu","pmSub","pmKid",
                                         "pF")))

Out_agesex %>% filter(w == max(w)) %>% group_by(par) %>% summarise(meanProp = mean(value)) %>% kable()

# Age-Sex Plot:
agesex_dynplot <- ggplot(Out_agesex, 
       aes(x = w, y = value, group = set, col = par)) + 
  geom_line()+
  facet_wrap(~par)+
  labs(x="Weeks", 
       y = "Proportion",
       title = "Age-Sex dynamics, Lesnoff, (LHS Parameter Sets)")+
  theme_bw()

growth_dynplot
agesex_dynplot
ggarrange(growth_dynplot, agesex_dynplot, ncol = 1)


## twoyr growth
twoyr_growth <- sapply(Out_lesnoffDyn, function(x)
  x[nrow(x),"sum_pop"] / x[(nrow(x)-(2*52)), "sum_pop"]
)

OutL2 <- Out_lesnoff %>%
  mutate(twoyr_growth = replace_na(twoyr_growth, 0))

twoyr_summplot <- ggplot(OutL2, aes(twoyr_growth))+
  geom_histogram(colour = "black",
                 alpha = 0.5)+
  geom_vline(xintercept = 1)+
  labs(x="Two year growth", 
       y = "Count", 
       title = "Distribution of final TWO year growth, Lesnoff, (LHS parameter sets)")+
  theme_bw()

twoyr_boxplot <- ggplot(OutL2, aes(y = twoyr_growth))+
  geom_boxplot()+
  labs(x= "", 
       y = "Two year growth", 
       title = "Final TWO year growth, Lesnoff, (LHS parameter sets)")+
  theme_bw()

twoyr_summplot

twoyr_boxplot

ggarrange(twoyr_summplot, twoyr_boxplot, ncol = 1)

summary(OutL2 %>% filter(twoyr_growth>0) %>% select(twoyr_growth)) %>% kable()


twoyr_min <- 0.922
twoyr_max <- 1.172

length(which(twoyr_growth >= twoyr_min & twoyr_growth <= twoyr_max))

OutL2 %>% filter(twoyr_growth >= twoyr_min & twoyr_growth <= twoyr_max)
L2_valid <- OutL2 %>% filter(twoyr_growth >= twoyr_min & twoyr_growth <= twoyr_max) %>% pull(set)
var_input_lesnoffv2 <- var_input_lesnoff[L2_valid, ]

# write.csv(var_input_lesnoffv2, file = "data/Applied_parameters/demographics-lesnoff_input2.csv", row.names = F)
```


```{r ranges}
# how to valid parameters fit in the RSA GSA range

RSApars <- read_csv(paste0("data/Applied_parameters/demographics","-lesnoff_check",".csv"), col_names=T) %>%
  select(RSA.min, RSA.max, parameter)

RSAranges <- RSApars %>% 
  select(parameter,
         RSA.min,
         RSA.max) %>% 
  gather(key = "datasource", value = "value", -parameter) %>%
  mutate(datasource = gsub("\\.min|\\.max","", datasource))

# ANALYSIS OF LESNOFF LHS PARAMETER SETS:

lesnoff_ranges <- var_input_lesnoff[L2_valid,] %>% 
  t() %>%
  as.data.frame() %>%
  mutate(min = apply(.,1,min),
         max = apply(.,1,max), 
         par = rownames(.)) %>%
  select(par,min,max) %>%
  gather(key = "key", value = "value", -par) %>%
  mutate(datasource = "lesnoff") %>%
  select(parameter = par, datasource, value) %>%
  rbind(RSAranges)

p1<- ggplot(lesnoff_ranges %>% filter(parameter %in% c("adu_f_max_yrs", "adu_m_max_yrs","min_age_offtake","min_age_repro")), aes(x=parameter, y=value, col = datasource))+
  geom_point(position=position_dodge(width=0.2))+
  geom_line(size = 1, position=position_dodge(width=0.2))+
  labs(x = "Parameter")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none",
        text = element_text(size=16))

p2 <- ggplot(lesnoff_ranges %>% filter(!parameter %in% c("adu_f_max_yrs", "adu_m_max_yrs","min_age_offtake","min_age_repro", "ppr_mortality_y", "ppr_mortality_a")), 
       aes(x=parameter, y=value, col = datasource))+
  geom_point(position=position_dodge(width=0.2))+
  geom_line(size = 1, position=position_dodge(width=0.2))+
  labs(x = "Parameter")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        text = element_text(size=16))

ggarrange(p1,p2)


```
