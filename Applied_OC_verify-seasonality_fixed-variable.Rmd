---
title: "oc_validVac_seasonal"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

# Verify implementation of seasonal and non-seasonal reprouction

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# libraries not accounted for in setup script
library(GGally)
plotsave <- F
custom_theme <- theme_bw() + theme(text = element_text(family = "Times New Roman", size = 9))
theme_set(custom_theme)

```

```{r modFunctions}
############
## SETUP ##
############
local <- T
# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc_seasonalfixed.R")) # wrapper function with fixed births
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac_seasonalfixed.R")) # flock dynamics model function with fixed births
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac

```


```{r modData}
# 9/11/23: Run model with LHS of oc parameter space. Analyse results against original valid population conditions and against oc population growth reports. 

applied_example <- T

## Load parameters
datafile <- "-OC_validPars-seasonal"
fix_age_data_full <- read_csv(paste0("data/Applied_parameters/state_vars",datafile,".csv"),col_names=T)
# var_demo_data_full <- read_csv(paste0("output/Applied/applied_outValidPars_OC_2023-12-11.csv"))
var_demo_data_full <- read_csv(paste0("output/Applied/applied_outValidPars100_OC_2024-01-14.csv"))

# load mean annual birth rate (calc from validVac non-seasonal.Rmd)
# nBirths_df <- read_csv("output/Applied/stableAgeSex/Applied_nBirths_OC.csv")
nBirths_df <- read_csv("output/Applied/stableAgeSex/Applied_nBirths_OC100.csv")
imm_decay_corrected <- read_csv("data/imm_decay_bodjo_v2.csv") 

## Datasets
datasets <- fix_age_data_full %>% select(-parameter) %>% colnames()
#combine nBirths with other demogrpahics
var_demo_data_full <- var_demo_data_full %>%
  mutate(nBirths_yr = nBirths_df$mean)

```

```{r modSetup}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## RUN MODEL ##
##################

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T
seasonal <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## BIRTH PEAKS  ##
##################################

# id which week of the year each month starts on:
wkmnthids <- data.frame(
  mnth = 1:12,
  mnthwk = seq(1,53, by = 4.345) %>% round()
)

peakmnth <- 3  # Month of peak
peakstart <- wkmnthids %>% filter(mnth == peakmnth) %>% pull()
pkwk1 <- seq(from=peakstart, by=1, length.out=8)
birthpeak_w <- c()
time_yrs <- TimeStop_dynamics/52
for(i in 1:time_yrs-1){
  seqjump <- i*52
  pkwki <- pkwk1+seqjump
  birthpeak_w <- c(birthpeak_w,pkwki)
}

##################################
## LHS SETUP  ##
##################################

lhs <- F
lhs_n <- 0 # number of sets (parameter combinations)
pairs_plot <- F
SA <- F

```

# Run model using one valid parameter set to compare, fixed births (seasonal and non-seasonal) with variable births (seasonal and non-seasonal)

```{r modRun-fixed}

###################
## MODEL OUTPUT ##
###################

## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.seasonal <- list()


#####################
## DATA SELECTION ##
#####################

dataset <- datasets

if (dataset == "lesnoff.ft") {
  rates <- "wkly"
} else{
  rates <- "yrly"
}

fixdata <- dataset # set dataset for state_vars
vardata <- dataset
  
if(lhs){
  source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.
}

profOrder <- var_demo_data_full %>% select(prof) %>% pull()
var_input_backup <- var_demo_data_full %>% select(-prof)

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")
  
  ##########################################
  ## SIMULATION - TEST 1 EXAMPLE ##
  ##########################################

var_input_full <- unlist(var_input_backup[1, ])

                             
ocOut.seasonalF <- App_func(
                  imm_decay_corrected,
                  var_input_full,
                  fix_age_data_full,
                  f_list,# initial state of female population
                  m_list, # initial state of male population
                  TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                  TimeStop_transmission, # 1 day, hourly timestep for transission component
                  output,# model output: tracker or summary stats
                  summary_df, #
                  clean_environment,
                  Vstart,
                  Vprog,
                  fixdata,
                  vardata,
                  birthpeak_w,
                  seasonal
                )
                                
  
stopCluster(cl)


seasonal <- F                      
ocOut.constantF <- App_func(
                  imm_decay_corrected,
                  var_input_full,
                  fix_age_data_full,
                  f_list,# initial state of female population
                  m_list, # initial state of male population
                  TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                  TimeStop_transmission, # 1 day, hourly timestep for transission component
                  output,# model output: tracker or summary stats
                  summary_df, #
                  clean_environment,
                  Vstart,
                  Vprog,
                  fixdata,
                  vardata,
                  birthpeak_w,
                  seasonal
                )

# ocOut.seasonalF and ocOut.constantF represent seasonal and non-seasonal simulations with fixed births
```

```{r modRun-variable}

source(paste0(filepath, "functions/dynmod-vac_seasonal.R")) # flock dynamics model function
source(paste0(filepath, "functions/Appliedfunc_seasonal.R")) # flock dynamics model function
seasonal <- T
summary_df <- output_func(TimeStop_dynamics, output) 
                                  
ocOut.seasonalV <- App_func(
                  imm_decay_corrected,
                  var_input_full,
                  fix_age_data_full,
                  f_list,# initial state of female population
                  m_list, # initial state of male population
                  TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                  TimeStop_transmission, # 1 day, hourly timestep for transission component
                  output,# model output: tracker or summary stats
                  summary_df, #
                  clean_environment,
                  Vstart,
                  Vprog,
                  fixdata,
                  vardata,
                  birthpeak_w,
                  seasonal
                )

seasonal <- F                              
ocOut.constantV <- App_func(
                  imm_decay_corrected,
                  var_input_full,
                  fix_age_data_full,
                  f_list,# initial state of female population
                  m_list, # initial state of male population
                  TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                  TimeStop_transmission, # 1 day, hourly timestep for transission component
                  output,# model output: tracker or summary stats
                  summary_df, #
                  clean_environment,
                  Vstart,
                  Vprog,
                  fixdata,
                  vardata,
                  birthpeak_w,
                  seasonal
                )

# ocOut.seasonalV and ocOut.constantV represent seasonal and non-seasonal simulations with variable birth rate

```

# Review whether population dynamics fluctuate around same average between seasonal and non-seasonal
```{r ocComparison}

ocOut.comparison <- bind_rows(ocOut.seasonalF %>% select(w, sum_pop, prop_immune) %>% mutate(id = "fixedSeasonal", births = "fixedBirths"),
                   ocOut.seasonalV %>% select(w, sum_pop, prop_immune) %>% mutate(id = "variableSeasonal", births = "variableBirths"), 
                   ocOut.constantF %>% select(w, sum_pop, prop_immune) %>% mutate(id = "fixedNonSeasonal", births = "fixedBirths"),
                   ocOut.constantV %>% select(w, sum_pop, prop_immune) %>% mutate(id = "variableNonSeasonal", births = "variableBirths"))

# calc mean annual population size for seasonal-fixed simulation, to compare with non-seasonal fixed :
mean.seasonalF <- ocOut.seasonalF %>% select(w, sum_pop) %>% mutate(yr = rep(1:(TimeStop_dynamics/52), each = 52)) %>% group_by(yr) %>% summarise(meanpop = mean(sum_pop)) %>% mutate(yr_wks = 52*yr)
mean.seasonalV <- ocOut.seasonalV %>% select(w, sum_pop) %>% mutate(yr = rep(1:(TimeStop_dynamics/52), each = 52)) %>% group_by(yr) %>% summarise(meanpop = mean(sum_pop)) %>% mutate(yr_wks = 52*yr)

# Check births are implemented at peak times as intended: 
startpos <- which(c(TRUE, diff(birthpeak_w) > 1))
endpos <- c(startpos[-1] - 1, length(birthpeak_w))
peakrect <- data.frame(startpeak = birthpeak_w[startpos],
                      endpeak = birthpeak_w[endpos])

# overall comparison on all births patterns:
ggplot() +
  geom_rect(
   data = peakrect,
    aes(
      xmin = startpeak,
      xmax = endpeak,
      ymin = -Inf,
      ymax = +Inf
    ),
    fill = "lightblue",
    alpha = 0.5,
    color = NA
  )+
   geom_line(data = ocOut.comparison, aes(x = w, y = sum_pop, col = id), size = 1)+
  labs(x = "weeks (10 year)", 
       y = "population size", 
       col = "birth pattern", 
       title = "Comparison of seasonal vs non-seasonal (constant) birth pattern")


# compare seaosnal and non-seasonal fixed births simulation: 
ggplot(ocOut.comparison %>% filter(births == "fixedBirths")) +
   geom_line(aes(x = w, y = sum_pop, col = id), size = 1)+
  # mean annual population for seasonal-fixed:
  geom_point(data = mean.seasonalF, aes(x=yr_wks, y = meanpop), col = "black")+
  labs(x = "weeks (10 year)", 
       y = "population size", 
       col = "birth pattern", 
       title = "Comparison of seasonal vs non-seasonal (fixed) birth pattern")


# compare fixed seasonal and variable seasonal data: 

A <- ggplot(ocOut.comparison %>% filter(id %in% c("variableSeasonal", "fixedSeasonal"))) +
   geom_line(aes(x = w, y = sum_pop, col = id), size = 1)+
  labs(x = "weeks (10 year)", 
       y = "population size", 
       col = "birth pattern", 
       title = "Seasonal fixed vs seasonal variable birth pattern")

B <- ggplot() +
   geom_point(data = mean.seasonalF, aes(x=yr_wks, y = meanpop), col = "red")+
     geom_line(data = mean.seasonalF, aes(x=yr_wks, y = meanpop), col = "red")+

    geom_point(data = mean.seasonalV, aes(x=yr_wks, y = meanpop), col = "blue")+
      geom_line(data = mean.seasonalV, aes(x=yr_wks, y = meanpop), col = "blue")+

  labs(x = "weeks (10 year)", 
       y = "population size", 
       col = "birth pattern", 
       title = "Mean Annual Population Size")

ggarrange(A,B,nrow=1)
```


# Review age-sex structure between seasonal and non-seasonal
```{r ocAgeSexCOmparison}


agesex.comparison <- bind_rows(ocOut.seasonalF %>% select(w, sum_pop, starts_with("pf"), starts_with("pm")) %>% mutate(id = "fixed"),
                   ocOut.seasonalV %>% select(w, sum_pop, starts_with("pf"), starts_with("pm")) %>% mutate(id = "variable"))


agesex.long <- agesex.comparison %>%
  gather(key = "age_group", value = "prop", -c(w,id)) %>%
  mutate(age_group = factor(age_group, levels = c("pfAdu", "pfSub","pfKid","pmAdu","pmSub","pmKid","pF", "sum_pop")))


ggplot(agesex.long %>% filter(!age_group == "sum_pop"), 
       aes(x=w,y=prop), group = id)+
  geom_line(aes(col = id))+
  facet_wrap(~age_group, ncol = 3)


ggplot()+
  geom_rect(
   data = peakrect,
    aes(
      xmin = startpeak,
      xmax = endpeak,
      ymin = -Inf,
      ymax = +Inf
    ),
    fill = "lightblue",
    alpha = 0.5,
    color = NA
  )+
  geom_line(data = agesex.long %>% filter(!age_group %in% c("sum_pop", "pF") ),
            aes(x=w,y=prop,col = id, group = id))+
  facet_wrap(~age_group, scales = "free", ncol = 2)+
  theme_bw()


## COmpare age-sex structure for seasonal and non-seasonal fixed birth scenarios:

agesex.comparison <- bind_rows(ocOut.seasonalF %>% select(w, sum_pop, starts_with("pf"), starts_with("pm")) %>% mutate(id = "seasonal"),
                   ocOut.constantF %>% select(w, sum_pop, starts_with("pf"), starts_with("pm")) %>% mutate(id = "constant"))


agesex.long <- agesex.comparison %>%
  gather(key = "age_group", value = "prop", -c(w,id)) %>%
  mutate(age_group = factor(age_group, levels = c("pfAdu", "pfSub","pfKid","pmAdu","pmSub","pmKid","pF", "sum_pop")))


ggplot(agesex.long %>% filter(!age_group == "sum_pop"), 
       aes(x=w,y=prop), group = id)+
  geom_line(aes(col = id))+
  facet_wrap(~age_group, ncol = 3)


ggplot()+
  geom_rect(
   data = peakrect,
    aes(
      xmin = startpeak,
      xmax = endpeak,
      ymin = -Inf,
      ymax = +Inf
    ),
    fill = "lightblue",
    alpha = 0.5,
    color = NA
  )+
  geom_line(data = agesex.long %>% filter(!age_group %in% c("sum_pop", "pF") ),
            aes(x=w,y=prop,col = id, group = id))+
  facet_wrap(~age_group, scales = "free", ncol = 2)+
  theme_bw()

```
