---
title: "Lesnoff_validation"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

# APPLIED EXAMPLES LHS - PRELIMINARY ANALYSIS 
- Analyse baseline demographics of applied examples with LHS of parameter space
- review population dynamics and age-sex structure, comparing against RSA demographic parameters
- check "validity" of output against initial conditions (RSA conditions): 15% growth, age-sex structure conditions

For lesnoff only: compare 2yr growth rate to raw data 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# ibraries not accounted for in setup script
library(GGally)
plotsave <- F
```

```{r modSetup1}
############
## SETUP ##
############
local <- T
# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc.R")) # wrapper function
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac.R")) # flock dynamics model function
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac

```

## Demographic Parameters Check:

```{r ranges}
# how to valid parameters fit in the RSA GSA range

## Load parameters
datafile <- "-lesnoff_check"
demographics <- read_csv(paste0("data/Applied_parameters/demographics",datafile,".csv"), col_names=T) %>%
  # remove fortnightly rates for range comparison
  select(-c(lesnoff.ft.min, lesnoff.ft.max))

checkRanges <- demographics %>% 
  gather(key = "datasource", value = "value", -parameter) %>%
  mutate(datasource = gsub("\\.min|\\.max","", datasource))

p1<- ggplot(checkRanges %>% filter(parameter %in% c("adu_f_max_yrs", "adu_m_max_yrs","min_age_offtake","min_age_repro")), aes(x=parameter, y=value, col = datasource))+
  geom_point(position=position_dodge(width=0.2))+
  geom_line(size = 1, position=position_dodge(width=0.2))+
  labs(x = "Parameter")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        
        text = element_text(size=16))

p2 <- ggplot(checkRanges %>% filter(!parameter %in% c("adu_f_max_yrs", "adu_m_max_yrs","min_age_offtake","min_age_repro", "ppr_mortality_y", "ppr_mortality_a")), 
       aes(x=parameter, y=value, col = datasource))+
  geom_point(position=position_dodge(width=0.2))+
  geom_line(size = 1, position=position_dodge(width=0.2))+
  labs(x = "Parameter")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none",
        text = element_text(size=16))

ggarrange(p1,p2, nrow = 2)



ranges_lesnoff <- ggarrange(p1,p2, nrow = 2)
filename_ranges <- "ranges_lesnoff.png"

if(plotsave){
  ggsave(paste0("plots/",filename_ranges), plot = ranges_lesnoff, width = 25, height = 20, units = "cm")
}


```


## 1. Verify Flock Dynamics
- For each profile run a sample of 50 parameter sets with full population dynamics simulated
- Plot the flock growth over time and the age-sex structure over time for preliminary analysis of model-profile behaviour

```{r selectData}
# 9/11/23: Run model with LHS of lesnoff parameter space. Analyse results against original valid population conditions and against lesnoff population growth reports. 

applied_example <- F

## Load parameters
datafile <- "-lesnoff_check"
source(paste0(filepath, "scripts/applied/applied_load_data2.R")) 

## Datasets
datasets <- fix_age_data_full %>% select(-c(parameter)) %>% colnames()
```

```{r modSetup2}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## RUN MODEL ##
##################

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## LHS DEMOGRAPHIC PARS ##
##################################

dataset <- "lesnoff.yr"
data_filename <- gsub("\\.","",dataset)

if(dataset == "lesnoff.ft"){
  rates <- "wkly"
}else{
  rates <- "yrly"
}

lhs <- T
lhs_n <- 1e4 # number of sets (parameter combinations)
pairs_plot <- F
SA <- TRUE

# set seed
set.seed(1) # so that results are consistent

pars_min <- paste0(dataset, ".min") # minimum val
pars_max <-  paste0(dataset, ".max") # maximum val
fixdata <- dataset # set dataset for state_vars
vardata <- dataset

source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

```


```{r modDynamics}

## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# Format demographic parameter sets:
var_input_backup <- var_input_df %>% as.data.frame() %>% slice_sample(n=50)

##############
## FOR LOOP ##
##############

# validOut = list to store outputs
GSAoutput <- c(); 
Out_list <- list()
validOut <- list()
validPars <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
lesnoffOut.dynamics <- foreach (i = 1:nrow(var_input_backup), 
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

############
############
```


```{r analysisDynamics}

# Transform Out (list) into a df of dynamics with each set identified:
Out_dynamics <- lesnoffOut.dynamics %>%
  do.call(rbind, .) %>% 
  mutate(set = rep(1:length(lesnoffOut.dynamics), each = TimeStop_dynamics))

# Population Growth plot:
growth_dynplot <- ggplot(Out_dynamics, 
       aes(x = w, y = sum_pop, group = set)) + 
  labs(x="weeks", 
       y = "Population Size",
       title = "Population growth over 20 years, Lesnoff, (LHS Parameter Sets)")+
  geom_line()+
  theme_bw()

fadeout <- Out_dynamics %>% filter(sum_pop==0) %>% distinct(set) %>% pull()
fadeout_dynplot <- ggplot(Out_dynamics %>% filter(set %in% fadeout), 
       aes(x = w, y = sum_pop, group = set)) + 
  labs(x="weeks", 
       y = "Population Size",
       title = "Population growth over 20 years, Lesnoff, (LHS Parameter Sets)")+
  geom_line()+
  theme_bw()

# AgeSex Dynamics df: 
Out_agesex <- Out_dynamics %>% 
  select(c("w", "set", starts_with("pf"), starts_with("pm"))) %>% 
  gather(key = "par", value = value, -c(w,set)) %>%
  mutate(par = factor(par, levels = c("pfAdu", "pfSub", "pfKid", 
                                         "pmAdu","pmSub","pmKid",
                                         "pF")))

# Age-Sex Plot:
agesex_dynplot <- ggplot(Out_agesex, 
       aes(x = w, y = value, group = set, col = par)) + 
  geom_line()+
  facet_wrap(~par)+
  labs(x="Weeks", 
       y = "Proportion",
       title = "Age-Sex dynamics, Lesnoff, (LHS Parameter Sets)")+
  theme_bw()

growth_dynplot
fadeout_dynplot
agesex_dynplot
ggarrange(growth_dynplot, agesex_dynplot, ncol = 1)


filename_growthDyn <- "growthDyn_lesnoff.png"
filename_fadeoutDyn <- "fadeoutDyn_lesnoff.png"
filename_agesexDyn <- "agesexDyn_lesnoff.png"


if(plotsave){
  ggsave(paste0("plots/",filename_growthDyn), plot = growth_dynplot, width = 20, height = 10, units = "cm")
   ggsave(paste0("plots/",filename_fadeoutDyn), plot = fadeout_dynplot, width = 20, height = 10, units = "cm")
  ggsave(paste0("plots/",filename_agesexDynG), plot = agesex_dynplot, width = 20, height = 20, units = "cm")
}
```


```{r modSummary}

## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# Format demographic parameter sets:
var_input_backup <- var_input_df %>% as.data.frame()

##############
## FOR LOOP ##
##############

# validOut = list to store outputs
GSAoutput <- c(); 
Out_list <- list()
validOut <- list()
validPars <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


################
## SIMULATION ##
################
lesnoffOut.summary <- foreach (i = 1:nrow(var_input_backup), 
                .packages = c("dplyr", "tibble"),
                .combine = "rbind"
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}

############
############
```

```{r analysisSummary}

################################
## POP & AGE-SEX SUMMARY ##
################################

# lesnoffOut.summary is a dataframe of summary data for each parameter set 

## Plot population growth stats: 
# - Total Growth (20y), 
# - tenyr Growth (10y), 
# - Finyr Growth (1y)

lesnoffOut.summary <- lesnoffOut.summary %>% 
  replace(is.na(.), 0)

# df of population growth stats:
popgrowth <- lesnoffOut.summary %>% 
  select(ends_with("growth")) %>% 
  gather(key = "par", value = "prop") %>% 
  mutate(par = factor(par, levels = c("pop_growth",
                                      "tenyr_growth", 
                                      "twoyr_growth",
                                      "finyr_growth")))

growth_boxplot <- ggplot(popgrowth, aes(x=par, y = prop))+
  geom_boxplot()+
  facet_wrap(~par, scales = "free", nrow = 1)+
  labs(x = "Growth Stat", 
       y = "Pop Growth",
       title = "Growth statistics for Lesnoff data, LHS parameter sets")+
  theme_bw()

growth_hist <- ggplot(popgrowth, aes(prop))+
  geom_histogram()+
  facet_wrap(~par, scales = "free", nrow = 1)+
  labs(x = "Pop Growth", 
       y = "Count")+
  theme_bw()

ggarrange(growth_boxplot, growth_hist, ncol = 1)

twoyr_boxplot <- ggplot(lesnoffOut.summary, aes(y = twoyr_growth))+
  geom_boxplot()+
  labs(x= "", 
       y = "Two year growth")+
  theme_bw()

twoyr_hist <- ggplot(lesnoffOut.summary, aes(twoyr_growth))+
  geom_histogram(colour = "black",
                 alpha = 0.5)+
  geom_vline(xintercept = 1)+
  labs(x="Two year growth", 
       y = "Count",
       title = "Final TWO year growth, Lesnoff, (LHS parameter sets)")+
  theme_bw()

ggarrange(twoyr_hist, twoyr_boxplot)

summary(lesnoffOut.summary %>% filter(twoyr_growth>0) %>% select(twoyr_growth)) %>% kable()


## Analyse age-sex dynamics:

# - Age-Sex plots
agesex <- lesnoffOut.summary %>% 
  select(starts_with("pf"), starts_with("pm")) %>% 
  gather(key = "par", value = "prop")

agesex_boxplot <- ggplot(agesex, aes(x=par, y = prop))+
  geom_boxplot(fill = "grey", 
               alpha = 0.5)+
  labs(x="Age-Sex Group", 
       y = "Proportion",
       title = "Stable Age-Sex structure, Lesnoff, (LHS parameter sets)")+
  theme_bw()
  
agesex_boxplot

summary_lesnoff <- ggarrange(growth_boxplot, growth_hist, agesex_boxplot, ncol = 1)

filename_summary <- "summary_lesnoff.png"

if(plotsave){
  ggsave(paste0("plots/",filename_summary), plot = summary_lesnoff, width = 20, height = 20, units = "cm")
}
```


```{r outValid}
#------------------------------------------------------------------------------
## VALID RESULTS ##

##################################
## Valid Age-Sex Conditions ##
##################################

## Min and max proportions for each sex-age group (see age-sex SS)
pfKid.min <- 0.05; pfKid.max <- 0.19
pfSub.min <- 0.06; pfSub.max <- 0.19
pfAdu.min <- 0.21; pfAdu.max <- 0.62

pmKid.min <- 0.05; pmKid.max <- 0.16
pmSub.min <- 0.04; pmSub.max <- 0.15
pmAdu.min <- 0.01; pmAdu.max <- 0.15
  

#########################################################
# Retain behavioral parameter sets
#########################################################

# add set id to output df:
lesnoffOut.summary <- lesnoffOut.summary %>%
  mutate(set = 1:nrow(lesnoffOut.summary))

# Edit Out to contain identifier variables for pop growth (5%,15%) and pop growth with age-sex structure 
lesnoffOut.growth <- lesnoffOut.summary %>%
  mutate(tenyr_growth = replace_na(tenyr_growth, 0),
         # add variables to identify parameter sets with growth between 5% and 15%
         tenyr_15 = ifelse(tenyr_growth>=0.85 & tenyr_growth <=1.15, 1, 0),
         tenyr_05 = ifelse(tenyr_growth>=0.95 & tenyr_growth <=1.05, 1, 0)) %>%
  
  # add variables to identify parameter sets with growth between 5% and 15% AND age-sex conditions
  mutate(
    tenyr_15age = ifelse(
      tenyr_15 == 1 &
        pfKid >= pfKid.min & pfKid <= pfKid.max &
        pfSub >= pfSub.min & pfSub <= pfSub.max &
        pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
        
        pmKid >= pmKid.min & pmKid <= pmKid.max &
        pmSub >= pmSub.min & pmSub <= pmSub.max &
        pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0),
    
    tenyr_05age = ifelse(
      tenyr_05 == 1 &
        pfKid >= pfKid.min & pfKid <= pfKid.max &
        pfSub >= pfSub.min & pfSub <= pfSub.max &
        pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
        
        pmKid >= pmKid.min & pmKid <= pmKid.max &
        pmSub >= pmSub.min & pmSub <= pmSub.max &
        pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0)
  )

lesnoffOut.growth %>% group_by(tenyr_15age, tenyr_05age) %>% count() %>% kable()

##################
## Valid Output ##
##################

lesnoffOut.valid <- lesnoffOut.growth %>%
  filter(tenyr_15age == 1 |
           tenyr_05age == 1)

## Refine parameter dataframe:
lesnoffPars.valid <- var_input_backup %>%
  mutate(set = 1:nrow(var_input_backup)) %>%
  left_join(lesnoffOut.valid %>%
              select(tenyr_growth,
                     tenyr_15,
                     tenyr_05,
                     tenyr_15age,
                     tenyr_05age,
                     set), by = c("set")) %>% 
  filter(tenyr_15age == 1 |
           tenyr_05age == 1)  %>%
  select(-c(tenyr_15,
            tenyr_05,
            set))


pairs(lesnoffPars.valid %>% select(-c(tenyr_growth,tenyr_05age,tenyr_15age)))

parsOutput <- lesnoffPars.valid %>% select(-c(tenyr_growth,tenyr_05age,tenyr_15age))
pars_filename <- "Applied_validPars_Lesnoff-check.csv"
write.csv(parsOutput, file = paste0("output/Applied/", pars_filename), row.names = F)

```



```{r validAgeSex}

lesnoffOut.validLong <- lesnoffOut.valid %>%
  select(starts_with("pf"), starts_with("pm")) %>% 
  gather(key = "par", value = "prop")

stable_agesex <- lesnoffOut.validLong %>% 
  group_by(par) %>%
  summarise(median = median(prop))

agesex_filename <- "Applied_AgeSex_Lesnoff.csv"
# write.csv(stable_agesex, file = paste0("output/Applied/stableAgeSex/", agesex_filename), row.names = F)

# shift to wide format

```