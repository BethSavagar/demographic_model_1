---
title: "oc_validVac"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

# APPLIED EXAMPLES LHS - PRELIMINARY ANALYSIS 
- Run model for valid pars

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# libraries not accounted for in setup script
library(GGally)
plotsave <- F
custom_theme <- theme_bw() + theme(text = element_text(family = "Times New Roman", size = 9))
theme_set(custom_theme)
```

```{r modSetup1}
############
## SETUP ##
############
local <- T
# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc.R")) # wrapper function
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac.R")) # flock dynamics model function
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac

```

Load data for O&C profiles: 
- parameter sets are output of validation step (validated against pop growth & age-sex structure)
- Run vaccination and post-vaccination immunity analysis on valid parameter sets only. 

```{r selectData}
# 9/11/23: Run model with LHS of oc parameter space. Analyse results against original valid population conditions and against oc population growth reports. 

applied_example <- T

## Load parameters
datafile <- "-oc_validPars"
fix_age_data_full <- read_csv(paste0("data/Applied_parameters/state_vars",datafile,".csv"),col_names=T)
var_demo_data_full <- read_csv(paste0("output/Applied/applied_outValidPars_OC_2023-12-05.csv"))
imm_decay_corrected <- read_csv("data/imm_decay_bodjo_v2.csv") 

## Datasets
datasets <- fix_age_data_full %>% select(-parameter) %>% colnames()
```

```{r modSetup2}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## RUN MODEL ##
##################

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## LHS SETUP  ##
##################################

lhs <- F
lhs_n <- 0 # number of sets (parameter combinations)
pairs_plot <- F
SA <- F

```


```{r loopDynamics}

###################
## MODEL OUTPUT ##
###################

## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.dynamics <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


#####################
## LOOP ##
#####################

dataset <- datasets

if (dataset == "lesnoff.ft") {
  rates <- "wkly"
} else{
  rates <- "yrly"
}

fixdata <- dataset # set dataset for state_vars
vardata <- dataset
  
if(lhs){
  source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.
}

profOrder <- var_demo_data_full %>% select(prof) %>% pull()
var_input_backup <- var_demo_data_full %>% select(-prof)
  
  ################
  ## SIMULATION ##
  ################
  Out.dynamics <- foreach (i = 1:nrow(var_input_backup),
                                .packages = c("dplyr", "tibble")) %dopar% {
                                  print(i)
                                  
                                  var_input_full <- unlist(var_input_backup[i, ])
                                  
                                  App_func(
                                    imm_decay_corrected,
                                    var_input_full,
                                    fix_age_data_full,
                                    f_list,# initial state of female population
                                    m_list, # initial state of male population
                                    TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                                    TimeStop_transmission, # 1 day, hourly timestep for transission component
                                    output,# model output: tracker or summary stats
                                    summary_df, #
                                    clean_environment,
                                    Vstart,
                                    Vprog,
                                    fixdata,
                                    vardata
                                  )
                                }
  
stopCluster(cl)

```

```{r popdyn}

custom_palette <- c("#004D40", "#00695C", "#00796B", "#00897B", "#009688", "#4A148C", "#6A1B9A", "#7B1FA2", "#8E24AA", "#9C27B0")

# ocOut.dynamics
popDynamics <- lapply(Out.dynamics, select, sum_pop) %>%
  bind_cols() %>%
  t() %>%
  as.data.frame()

colnames(popDynamics) <- 1:ncol(popDynamics)
rownames(popDynamics) <- 1:nrow(popDynamics)

popDynamics.clean <- popDynamics %>%
  mutate(prof = profOrder,
         set = 1:nrow(.))

popDynamics.long <- popDynamics.clean %>%
  gather(key = "weeks", value = "sum_pop", -c(prof,set)) %>%
  mutate(weeks = as.numeric(weeks))

plot_popDyn <- ggplot(popDynamics.long, aes(x = weeks, y = sum_pop)) +
  geom_line(aes(group = set), col = "grey") +
  facet_wrap(~prof, nrow = 2)+
  labs(x="Time (weeks)", y = "Sum Pop ", col = "Profile")

plot_popDyn



# ocOut.dynamics
Births <- lapply(Out.dynamics, select, c(nBirths)) %>%
  bind_cols() %>%
  t() %>%
  as.data.frame()

colnames(Births) <- 1:ncol(Births)
rownames(Births) <- 1:nrow(Births)

births.clean <- Births %>%
  mutate(prof = profOrder,
         set = 1:nrow(.)
  )


births.long <- births.clean %>%
  gather(key = "weeks", value = "nBirths", -c(prof,set)) %>%
  mutate(weeks = as.numeric(weeks),
          yr = rep(
           rep(1:(TimeStop_dynamics/52), each = 52), 
           length(profOrder)
           )) 

plot_births <- ggplot(births.long, aes(x = weeks, y = nBirths)) +
  geom_line(aes(group = set), col = "grey") +
  facet_wrap(~prof, nrow = 2)+
  labs(x="Time (weeks)", y = "Sum Pop ", col = "Profile")

plot_births

births.sum <- births.long %>%
  group_by(set,prof,yr) %>%
  summarise(yrBirths = sum(nBirths))

plot_sumbirths <- ggplot(births.sum, aes(x = yr, y = yrBirths)) +
  geom_line(aes(group = set), col = "grey") +
  facet_wrap(~prof, nrow = 2)+
  labs(x="Time (weeks)", y = "Sum Pop ", col = "Profile")

plot_sumbirths


births.mean <- births.sum %>%
  ungroup() %>%
  group_by(set, prof) %>%
  summarise(mean = mean(yrBirths))

kable(births.mean)
filename_nBirths <- "Applied_nBirths_OC.csv"
write.csv(births.mean, file = paste0("output/Applied/stableAgeSex/", filename_nBirths), row.names = F)

```

# Plot Immunity Dynamics of valid OC flock profiles:

```{r analysisDynamics}


custom_palette <- c("#004D40", "#00695C", "#00796B", "#00897B", "#009688", "#4A148C", "#6A1B9A", "#7B1FA2", "#8E24AA", "#9C27B0")

# ocOut.dynamics
immDynamics <- lapply(Out.dynamics, select, prop_immune) %>%
  bind_cols() %>%
  t() %>%
  as.data.frame()

colnames(immDynamics) <- 1:ncol(immDynamics)
rownames(immDynamics) <- 1:nrow(immDynamics)

immDynamics.clean <- immDynamics %>%
  select((t2):ncol(immDynamics)) %>%
  mutate(prof = profOrder)

immDynamics.long <- immDynamics.clean %>%
  gather(key = "weeks", value = "prop_immune", -prof) %>%
  mutate(weeks = as.numeric(weeks))

# Calculate mean and confidence interval
summary_data <- immDynamics.long %>%
  group_by(prof,weeks) %>%
  summarise(
    mean_value = mean(prop_immune),
    lower_ci = quantile(prop_immune, 0.025),
    upper_ci = quantile(prop_immune, 0.975)
  )

plot_immVar <- ggplot(summary_data, aes(x = weeks, y = mean_value, group = prof)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), fill = "grey", alpha = 0.5) +
  geom_line(aes(col = prof)) +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~prof, nrow = 2)+
  labs(x="Time (weeks)", y = "Proportion Immune", col = "Profile")+
  coord_cartesian(xlim = c(500,750))+
  scale_colour_manual(values = custom_palette)

plot_immVar

filename_immVar <- "ImmDyn100_OCvalid.png"
# ggsave(paste0("plots/applied/",filename_immVar), plot = plot_immVar, width = 20, height = 10, units = "cm")

```

# Plot Immunity Stats of valid OC flock profiles:


```{r loopSummary}

###################
## MODEL OUTPUT ##
###################

## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.summary <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")


#####################
## LOOP ##
#####################

dataset <- datasets

if (dataset == "lesnoff.ft") {
  rates <- "wkly"
} else{
  rates <- "yrly"
}

fixdata <- dataset # set dataset for state_vars
vardata <- dataset
  
if(lhs){
  source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.
}

profOrder <- var_demo_data_full %>% select(prof) %>% pull()
var_input_backup <- var_demo_data_full %>% select(-prof)
  
  ################
  ## SIMULATION ##
  ################
  Out.summary <- foreach (i = 1:nrow(var_input_backup),
                                .packages = c("dplyr", "tibble"),
                           .combine = "rbind") %dopar% {
                                  print(i)
                                  
                                  var_input_full <- unlist(var_input_backup[i, ])
                                  
                                  App_func(
                                    imm_decay_corrected,
                                    var_input_full,
                                    fix_age_data_full,
                                    f_list,# initial state of female population
                                    m_list, # initial state of male population
                                    TimeStop_dynamics,# 1 year, weekly timestep for demographic component
                                    TimeStop_transmission, # 1 day, hourly timestep for transission component
                                    output,# model output: tracker or summary stats
                                    summary_df, #
                                    clean_environment,
                                    Vstart,
                                    Vprog,
                                    fixdata,
                                    vardata
                                  )
                                }
  
stopCluster(cl)

```


```{r summaryAnalysis}

dark2_palette <- c(brewer.pal(n = 8, name = "Dark2"), "#FF8C00", "#1E90FF", "#333333")

dark2_palette

######################################
## Vaccination Uncertainty Examples ##
######################################
validImm <- Out.summary %>%
  mutate(prof = profOrder,
         prof_group = ifelse(grepl("*shp*", prof), "shp", "goat"),
         prof = factor(
      prof,
      levels = c(
        "oc.goat.aridP",
        "oc.goat.semiaridP",
        "oc.goat.semiaridM",
        "oc.goat.subhumidM",
        "oc.goat.humidM",
        "oc.shp.aridP",
        "oc.shp.semiaridP",
        "oc.shp.semiaridM",
        "oc.shp.subhumidM",
        "oc.shp.humidM"
      )
    )) %>%
  select(tenyr_growth, starts_with("imm"), prof, prof_group) %>%
  gather(key = "stat", value = "value", -c(prof,prof_group)) %>%
  mutate(stat = factor(stat, levels = c("imm_V0", "imm_6m", "imm_12m", "imm70_w", "tenyr_growth" )))

plot_imm <- ggplot(validImm %>% filter(stat %in% c("imm_V0", "imm_6m", "imm_12m")), 
       aes(x = prof, y = value, fill = stat))+ 
  geom_boxplot() +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~stat)+
  labs(x="Profile", y = "Weeks")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")+
  scale_fill_manual(values = dark2_palette[1:3])

plot_imm70 <- ggplot(validImm %>% filter(stat %in% c("imm70_w")), 
            aes(x = value, y = prof))+ 
  geom_boxplot(fill = "grey", alpha = 0.5) +
  facet_wrap(~stat, scales = "free")+
  labs(x="Weeks", y = "Profile")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")

validImm %>% filter(stat =="imm70_w") %>% summarise(min = min(value), 
                                                                           max = max(value), 
                                                                           median = median(value),
                                                                           mean = mean(value))
validImm %>% filter(stat =="imm70_w") %>% group_by(prof_group) %>% summarise(min = min(value), 
                                                                           max = max(value), 
                                                                           median = median(value),
                                                                           mean = mean(value))

validImm %>% group_by(stat) %>% summarise(min = min(value), 
                                                                           max = max(value), 
                                                                           median = median(value),
                                                                           mean = mean(value)) %>% kable()

validImm %>% group_by(stat, prof) %>% summarise(min = min(value), 
                                                                           max = max(value), 
                                                                           median = median(value),
                                                                           mean = mean(value)) %>% kable()


plot_tenyr <- ggplot(validImm %>% filter(stat %in% c("tenyr_growth")), 
                 aes(x = prof, y = as.numeric(value), fill = stat))+ 
  geom_boxplot() +
  facet_wrap(~stat, scales = "free")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        legend.position = "none")+
  scale_fill_manual(values = dark2_palette[5])
plot_imm
plot_imm70
plot_ImmSum <- ggarrange(plot_imm,plot_imm70,plot_tenyr, ncol = 1)


filename_pairsSh <- "pairsvalid_SAOCShp.png"
filename_pairsGt <- "pairsvalid_SAOCGt.png"
filename_ImmSum <- "ImmSum100_OC.png"

if(plotsave){
  ggsave(paste0("plots/applied/",filename_pairsSh), plot = plot_pairsSh, width = 25, height = 20, units = "cm")
ggsave(paste0("plots/applied/",filename_pairsGt), plot = plot_pairsGt, width = 25, height = 20, units = "cm")
ggsave(paste0("plots/applied/",filename_ImmSum), plot = plot_ImmSum, width = 25, height = 20, units = "cm")
}



```