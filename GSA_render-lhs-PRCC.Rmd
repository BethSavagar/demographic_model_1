---
title: "oc_validation"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

# Global Sensitivity Analysis - LHS-PRCC

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r theme}
custom_theme <- theme_bw() + theme(text = element_text(family = "Times New Roman", size = 11))
theme_set(custom_theme)
```

# RSA analysis conducted on 200,000 parameters generated by LHS see RSA_render scripts and see below for corresponding model output nad parameter inputs
# population dynamics: 
RSAoutput <- read.csv("output/RSA_output/RSA_output_2023-08-24.csv")
# parameter sets:
var_input_set <- read.csv("output/RSA_output/RSA_pars-set_2023-08-24.csv")


# The parameter sets producing valid outputs are identified in the RSA_analysis_3.R script and saved as:
- GSA_var_input-PRCC in data folder for GSA analysis with PRCC
- this .csv can be used as input for GSA on the valid parameter sets produced with LHS as per the below:

```{r modSetup1}
############
## SETUP ##
############
local <- T
# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}


source(paste0(filepath,"scripts/setup.R")) # load libraries

# Functions:
source(paste0(filepath, "functions/demos_summary.R"))
source(paste0(filepath, "functions/dynmod-vac.R"))
source(paste0(filepath, "functions/GSA_outputs.R"))
source(paste0(filepath, "functions/GSAfunc.R"))
source(paste0(filepath, "functions/output.R"))

# load fixed pars: flock age-sex structure
fix_age_data_full <- read_csv("data/GSA_parameters/GSA_fix_input.csv",col_names=T)
imm_decay_corrected <- read_csv("data/imm_decay_bodjo_v2.csv") 
# load variable demographic inputs: this is the valid output from the initial RSA analysis
var_demo_data_full <- read_csv("data/GSA_parameters/GSA_var_input-PRCC.csv", col_names=T)

```

## Demographic Parameters Check:

```{r }

## MODEL PARAMETERS ##

TimeStop_dynamics <- 20*52 # 10 years
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
Vstart <- 10*52 # 20 years
output <- "summary_all" # define output type "summary" (age proporiotns), "summary_all" (age-sex proportions) or "count"
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

#######################
## Vaccination Setup ##
#######################

Vprog <- data.frame(
  Vround = 1,
  Vtype = "full",
  Vweek = Vstart,
  Vmin = 1,
  Vmax = NA,
  pV = 1
)

Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

# ---------------------------------
## SENSITIVITY ANALYSIS PARAMETERS:
pairs_plot <- F
SA <- TRUE
rates <- "yrly"
set.seed(1)

# select parameter min-max pair (see RSA_var_input.csv)
pars_min <- "min.1" # min.1, max.1 for conditions used for RSA 240723
pars_max <- "max.1" # min.4, max.4 include young male offtake and increase age of males
if(rates == "wkly"){
  pars_min <- "wkly.min.1"
  pars_max <- "wkly.max.1"
}
fixdata <- "sim.1" # fix_input_2 : sim.2 for pR=1... 
# fixdata <- "sim.3" # sim.3 for N = 100 (14-07-2023)
vardata <- "sim.1" # select dataset for test data, # test_1 dataset, all pars set to 0 and all animals in age group 1 (susceptible)

## Use RSA output as GSA input pars:

# original local data source: read_csv("output/RSA_output/RSA_pars-set_2023-08-24.csv")
var_input_set <- var_demo_data_full %>% rename(
  "NET_offtake_m"= off_mA,
  "NET_offtake_f"= off_f,
  "mortality_y"= mort_Y,
  "mortality_a"= mort_A,
  "birth_rate"= birth_rate,
  "adu_f_max_yrs"= max_yrs_F,
  "adu_m_max_yrs"= max_yrs_M,
  "min_age_offtake"= min_off,
  "min_age_repro"= min_repro,
  "NET_offtake_m2"=off_mY 
)

```


```{r runGSAmodel}
GSAoutput <- c()
pop_dynamics <- c()
summary_df <- output_func(TimeStop_dynamics, output) # create summary data frame to store summary stats for each timestep
turnover <- F; dynamics <- T; transmission <- F; 
clean_environment <- T

# timepoints for the population growth
t2 <- TimeStop_dynamics/2
t1 <- TimeStop_dynamics

var_input_backup <- var_input_set %>% as.data.frame()

## PARALLELISATION ##

cores=detectCores()
cl <- makeCluster(cores[1]-1) # for running locally
registerDoParallel(cl)

GSAout <- foreach (i = 1:nrow(var_input_backup), 
                   .packages = c("dplyr"),
                   .combine = "rbind") %dopar% {
                   
                     print(i)
# i <- sample(nrow(var_input_backup),1)
                     var_input_full <- unlist(var_input_backup[i,])
                     
                     GSA_func(
                       imm_decay_corrected,
                       var_input_full,
                       # var_input_backup[2,],
                       fix_age_data_full,
                       f_list, # initial state of female population
                       m_list, # initial state of male population
                       TimeStop_dynamics, # 1 year, weekly timestep for demographic component
                       TimeStop_transmission, # 1 day, hourly timestep for transission component
                       output, # model output: tracker or summary stats
                       summary_df, #
                       clean_environment,
                       Vstart,
                       Vprog
                     )
                   }
stopCluster(cl)


```


```{r GSAanalysis}

################
# Load Datasets
################

# population dynamics: 
GSAoutput <- GSAout
# parameter sets:
pars_input <- var_input_set

# behavioural parameters with +/- 15% growth saved as GSA_var_input-PRCC in data folder for GSA analysis with PRCC

# take a look at the data: 
str(GSAoutput) # output contains population and immunity dyanmics and age-sex structure from sobol sampling of refined parameter ranges. 
str(pars_input) # contains parameter sets for each output
summary(pars_input)


################
# Clean Data 
################

# add set id to output df:
GSAoutput <- GSAoutput %>%
  mutate(GSAset = 1:nrow(GSAoutput))

# tidy parameters dataframe: 
pars_input <- pars_input %>%
  select(NET_offtake_m, NET_offtake_m2, NET_offtake_f, everything()) %>%
  rename(off_mY = NET_offtake_m2,
         off_mA = NET_offtake_m,
         off_f = NET_offtake_f,
         mort_Y = mortality_y,
         mort_A = mortality_a,
         max_yrs_F = adu_f_max_yrs,
         max_yrs_M = adu_m_max_yrs,
         min_off = min_age_offtake,
         min_repro = min_age_repro
  ) %>%
  mutate(GSAset = 1:nrow(pars_input))

## If needed creation of parameter dataframe with outputs of interest:
# 
# GSA_all <- pars_input %>%
#   left_join(GSAoutput %>% select(c("GSAset","pop_growth","tenyr_growth","imm_6m","imm_12m","imm70_w")), by = c("GSAset")) %>%
#   select(-GSAset)


#########################################################
# Analysis 1 - Identify behavioral parameter GSAsets
#########################################################

# Define age-sex structure conditions: 

## Min and max proportions for each sex-age group (see age-sex SS)

pfKid.min <- 0.05; pfKid.max <- 0.19
pfSub.min <- 0.06; pfSub.max <- 0.19
pfAdu.min <- 0.21; pfAdu.max <- 0.62

pmKid.min <- 0.05; pmKid.max <- 0.16
pmSub.min <- 0.04; pmSub.max <- 0.15
pmAdu.min <- 0.01; pmAdu.max <- 0.15

####################
## GSA ANALYSIS 1 ##
####################
params <- colnames(pars_input %>% select(-GSAset))

# (i) overall population growth
GSAoutput <- GSAoutput %>%
  mutate(pop_growth = replace_na(pop_growth,0),
         tenyr_growth = replace_na(tenyr_growth,0),)

####################
## GSA ANALYSIS 2 ##
####################

## SETUP ##

# Analysis on only behavioural parameter sets

GSAoutput_ext <- GSAoutput %>%
  mutate(tenyr_growth = replace_na(tenyr_growth, 0),
         # add variables to identify parameter sets with growth between 5% and 15%
         tenyr_15 = ifelse(tenyr_growth>=0.85 & tenyr_growth <=1.15, 1, 0),
         tenyr_05 = ifelse(tenyr_growth>=0.95 & tenyr_growth <=1.05, 1, 0)) %>%
  
  # add variables to identify parameter sets with growth between 5% and 15% AND age-sex conditions
  mutate(
    tenyr_15age = ifelse(
      tenyr_15 == 1 &
      pfKid >= pfKid.min & pfKid <= pfKid.max &
      pfSub >= pfSub.min & pfSub <= pfSub.max &
      pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
      
      pmKid >= pmKid.min & pmKid <= pmKid.max &
      pmSub >= pmSub.min & pmSub <= pmSub.max &
      pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0),
    
    tenyr_05age = ifelse(
      tenyr_05 == 1 &
        pfKid >= pfKid.min & pfKid <= pfKid.max &
        pfSub >= pfSub.min & pfSub <= pfSub.max &
        pfAdu >= pfAdu.min & pfAdu <= pfAdu.max &
        
        pmKid >= pmKid.min & pmKid <= pmKid.max &
        pmSub >= pmSub.min & pmSub <= pmSub.max &
        pmAdu >= pmAdu.min & pmAdu <= pmAdu.max,1,0)
  )

# How many parameter sets are behavioural for growth of 5%, 15% and growth of 5%-15% with age-sex structure.

GSAoutput_ext %>% group_by(tenyr_15, tenyr_05) %>% count()
GSAoutput_ext %>% group_by(tenyr_15age) %>% count()
GSAoutput_ext %>% group_by(tenyr_05age) %>% count()

## ID which parameter sets are within 15% growth and age-sex conditions

par_subset <- pars_input %>% left_join(GSAoutput_ext %>% select(c(pop_growth,tenyr_growth,imm_6m,imm_12m,imm70_w,tenyr_15age,GSAset)), by = c("GSAset")) %>% filter(tenyr_15age==1) 

parOnly_subset <- par_subset %>%
  select(-c(pop_growth,tenyr_growth,imm_6m,imm_12m,imm70_w,tenyr_15age,GSAset))

pairs(par_subset, pch=18)
ggpairs(par_subset)

# PRCC on subset

# 6m Imm
dat.1b <- par_subset %>% select(-c(GSAset,
                                        "pop_growth",
                                        "tenyr_growth",
                                        "imm_12m",
                                        "imm70_w",
                                        "tenyr_15age"))

prccb_imm6m <- epi.prcc(dat.1b, sided.test = 2, conf.level = 0.95)

dat.2b <- par_subset %>% select(-c(GSAset,
                                        "pop_growth",
                                        "tenyr_growth",
                                        "imm_6m",
                                        "imm70_w",
                                        "tenyr_15age"))

prccb_imm12m <- epi.prcc(dat.2b, sided.test = 2, conf.level = 0.95)

dat.3b <- par_subset %>% select(-c(GSAset,
                                        "pop_growth",
                                        "tenyr_growth",
                                        "imm_6m",
                                        "imm_12m",
                                        "tenyr_15age"))

prccb_imm70 <- epi.prcc(dat.3b, sided.test = 2, conf.level = 0.95)

dat.4b <- par_subset %>% select(-c(GSAset,
                                        "pop_growth",
                                        "imm_6m",
                                        "imm_12m",
                                        "imm70_w",
                                        "tenyr_15age"))

prccb_growth <- epi.prcc(dat.4b, sided.test = 2, conf.level = 0.95)

GSAsubset_prccgrowth <- ggplot(prccb_growth, aes(x=var, y=est, group = output, fill = output))+
  geom_col(position = "dodge")+
  labs(x="par", y="prcc", title = "VALID ONLY")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
GSAsubset_prccgrowth

# Bar plot comparing prcc for each output
prccb.all <- rbind(prccb_imm6m %>% select(var,est) %>% mutate(output = "imm6m"),
                  prccb_imm12m %>% select(var,est) %>% mutate(output = "imm12m"),
                  prccb_imm70 %>% select(var,est) %>% mutate(output = "imm70"), 
                  prccb_growth %>% select(var,est) %>% mutate(output = "pop_growth"))


prcc_summary <- prccb_imm6m %>% 
  select(var,est,p.value) %>% 
  transmute(var = var,
            est6m=round(est,digits=3),
            p6m= round(p.value, digits=3)) %>%
  cbind(prccb_imm12m %>% 
          select(var,est,p.value) %>% 
          transmute(est12m=round(est,digits=3),
                    p12m= round(p.value, digits=3))) %>%
  cbind(prccb_imm70 %>% 
          select(var,est,p.value) %>% 
          transmute(est70=round(est,digits=3),
                    p70= round(p.value, digits=3))) %>%
  arrange(desc(abs(est70)))

knitr::kable(prcc_summary)
# varOrder <- prcc_summary %>% select(var) %>% pull()
# varOrder <- c("off_f", "off_mY", "off_mA", "mort_Y", "mort_A", "birth_rate", "min_off", "min_repro", "max_yrs_F","max_yrs_M")

GSAsubset_prccimmunity <- ggplot(prccb.all %>% mutate(var = factor(var, levels = rev(varOrder))) %>% filter(!output == "pop_growth"), 
       aes(x=est, y=var, group = output, fill = output))+
  geom_col(position = "dodge")+
  labs(x="PRCC", y="Demographic Parameter", fill = "Output", title = "")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  scale_fill_grey()
GSAsubset_prccimmunity

GSAsubset_prccall <- ggplot(prccb.all, aes(x=est, y=var, group = output, fill = output))+
  geom_col(position = "dodge")+
  labs(x="PRCC", y="Demographic Parameter", fill = "Output", title = "")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
GSAsubset_prccall

GSAsubset_prccall2 <- ggplot(prccb.all, aes(x=est, y=var, group = output, fill = output))+
  geom_col(position = "dodge")+
  facet_wrap(~output, nrow =1)+
  labs(x="PRCC", y="Demographic Parameter", fill = "Output", title = "")+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
GSAsubset_prccall2

filename_GSAsubset_prccall <- "GSAsubset_prccall.png"
filename_GSAsubset_prccall2 <- "GSAsubset_prccall2.png"
filename_GSAsubset_prccimmunity <- "GSAsubset_prccimmunity.png"

if(plotsave){
  ggsave(paste0("plots/GSA/",filename_GSAsubset_prccall), plot = GSAsubset_prccall, width = 12, height = 7.5, units = "cm")
  ggsave(paste0("plots/GSA/",filename_GSAsubset_prccall2), plot = GSAsubset_prccall2, width = 20, height = 10, units = "cm")
  ggsave(paste0("plots/GSA/",filename_GSAsubset_prccimmunity), plot = GSAsubset_prccimmunity, width = 20, height = 15, units = "cm")
  
}

prcc.all2 <- rbind(
                   prccb.all %>% mutate(Cond = "VALID"),
                   prccb_growth %>% select(var,est) %>% 
                     mutate(output = "popgrowth",
                            Cond="VALID")
                   )
# Plot of PRCC for each output (immunity nad popgrowth), for Valid and All par sets
prcc_comparison <- ggplot(prcc.all2, aes(x=est, y=var, group = Cond, fill = Cond))+
  geom_col(position = "dodge")+
  facet_wrap(~output, nrow = 1)+
  labs(x="par", y="prcc", title = "")+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

filename_prcc_comparison <- "prcc_comparison.png"

if(plotsave){
  ggsave(paste0("plots/GSA/",filename_prcc_comparison), plot = prcc_comparison, width = 20, height = 10, units = "cm")

  
}


```

