---
title: "Lesnoff_validation"
author: "Beth Savagar"
date: "2023-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

applied_example <- F
local <- T

############
## SETUP ##
############

# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc.R")) # wrapper function
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac.R")) # flock dynamics model function
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac
```


```{r}
## Load parameters
datafile <- "-lesnoff_validation"
source(paste0(filepath, "scripts/applied/applied_load_data2.R")) 

## Datasets
datasets <- fix_age_data_full %>% select(-c(parameter)) %>% colnames()

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 2*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0

## Model Output
output <- "pop_tracker" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pV <- 1
source("scripts/applied/applied_vaccination.R")
Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)

##################
## RUN MODEL ##
##################

# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")

```



## Female Mortality Rates

```{r Fmort_target}

##################################
## LHS DEMOGRAPHIC PARS ##
##################################

dataset <- "lesnoff.mortF"
data_filename <- gsub("\\.","",dataset)

lhs <- T
lhs_n <- 1e3 # number of sets (parameter combinations)
pairs_plot <- F
SA <- TRUE

# set seed
set.seed(1) # so that results are consistent

pars_min <- paste0(dataset, ".min") # minimum val
pars_max <-  paste0(dataset, ".max") # maximum val
fixdata <- dataset # set dataset for state_vars
vardata <- dataset

source("scripts/applied/applied_lhs.R") # output var_input_df contains all parameter combinations for uncertain demographics.

# Format demographic parameter sets:
var_input_backup <- var_input_df %>% as.data.frame()

Out <- c()

################
## SIMULATION ##
################
Out <- foreach (i = 1:nrow(var_input_backup), 
                .packages = c("dplyr", "tibble")
) %dopar% {
  
  print(i)
  var_input_full <- unlist(var_input_backup[i,])
  
  App_func(
    imm_decay_corrected,
    var_input_full,
    fix_age_data_full,
    f_list, # initial state of female population
    m_list, # initial state of male population
    TimeStop_dynamics, # 1 year, weekly timestep for demographic component
    TimeStop_transmission, # 1 day, hourly timestep for transission component
    output, # model output: tracker or summary stats
    summary_df, #
    clean_environment,
    Vstart,
    Vprog,
    fixdata,
    vardata
  )
}


```


```{r mortF_filter}

# quickplot:

# test <- Out[[1]]
# 
# ggplot(test, aes(x=w, y=pfKid))+geom_point()

# female mortality <12m target
F1targ_minW <- 0.006
F1targ_maxW <- 0.007

F2targ_minW <- 0.0025
F2targ_maxW <- 0.0035

F_max_age <- var_input %>% distinct(adu_f_max_yrs) %>% pull()
# calc F1 and F2 weekly mortality
mort_F1s <- sapply(Out, function(x) {
  testdf <- x %>% mutate(age = rep(1:(F_max_age*52), TimeStop_dynamics))
  F0init <- testdf %>% filter(w == 1, age == 1) %>% pull("fpop")
  F12end <- testdf %>% filter(w == 52, age == 52) %>% pull("fpop")
  
  mort_A <- 1 - F12end / F0init # annual mortality
  mort_F <- 1 - ((1 - mort_A) ^ (1 / 26)) # fortnightly mortality
  
  return(mort_F)
})

summary(mort_F1s)

valid_mortF1 <- which(mort_F1s>=F1targ_minW & mort_F1s<=F1targ_maxW)
valid_mortF1_df <- var_input_backup[valid_mortF1, ] %>% select(mortality_y, mortality_a)

ggplot(valid_mortF1_df, aes(x=mortality_y, y = mortality_a))+geom_point()


# calc F1 and F2 weekly mortality
mort_F2s <- sapply(Out, function(x) {
  testdf <- x %>% mutate(age = rep(1:(F_max_age*52), TimeStop_dynamics))
  F0init <- testdf %>% filter(w == 53, age == 53) %>% pull("fpop")
  F12end <- testdf %>% filter(w == 104, age == 104) %>% pull("fpop")
  
  mort_A <- 1 - F12end / F0init # annual mortality
  mort_F <- 1 - ((1 - mort_A) ^ (1 / 26)) # fortnightly mortality
  
  return(mort_F)
})

summary(mort_F2s)

valid_mortF2 <- which(mort_F2s>=F2targ_minW & mort_F2s<=F2targ_maxW)
valid_mortF2_df <- var_input_backup[valid_mortF2, ] %>% select(mortality_y, mortality_a)

ggplot(valid_mortF2_df, aes(x=mortality_y, y = mortality_a))+geom_point()

valid_mortF1F2 <- which(valid_mortF1 %in% valid_mortF2)
valid_mortF1F2_df <- var_input_backup[valid_mortF1F2, ] %>% select(mortality_y, mortality_a)

ggplot(valid_mortF1F2_df, aes(x=mortality_y, y = mortality_a))+geom_point()


```


