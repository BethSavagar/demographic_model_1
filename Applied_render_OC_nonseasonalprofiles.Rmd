---
title: "validvac_nonseasonalFixed"
author: "Beth Savagar"
date: "2023-12-11"
output: html_document
---

# Script for immunity analysis of flock profiles with nonseasonal reproduction:

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
# libraries not accounted for in setup script
library(GGally)
plotsave <- F
custom_theme <- theme_bw() + 
  theme(text = element_text(family = "Times New Roman", size = 10),
        panel.grid.minor = element_blank())
theme_set(custom_theme)

# custom_palette <- c("#004D40", "#00695C", "#00796B", "#00897B", "#009688", "#4A148C", "#6A1B9A", "#7B1FA2", "#8E24AA", "#9C27B0")

```

```{r modSetup1}
############
## SETUP ##
############
local <- T
# local filepath: 
if(local){
  filepath <- ""
}else{
  # cluster filepath
  filepath <- "/storage/users/bsavagar/"
}

## Libraries
source(paste0(filepath,"scripts/setup.R")) 

## Functions:
source(paste0(filepath, "functions/Appliedfunc_seasonalfixed.R")) # wrapper function
source(paste0(filepath, "functions/demos_summary.R")) # summary stats for output
source(paste0(filepath, "functions/dynmod-vac_seasonalfixed.R")) # flock dynamics model function
source(paste0(filepath, "functions/output.R")) # what to include in output df
source(paste0(filepath, "functions/GSA_outputs.R")) # summary stats accounting for vac

```


```{r selectData}
# 9/11/23: Run model with LHS of oc parameter space. Analyse results against original valid population conditions and against oc population growth reports. 

applied_example <- T

## Load parameters
datafile <- "-OC_validPars-seasonal"
fix_age_data_full <- read_csv(paste0("data/Applied_parameters/state_vars",datafile,".csv"),col_names=T)
var_demo_data_full <- read_csv(paste0("output/Applied/applied_outValidPars_OC_2023-12-11.csv"))
# load mean annual birth rate (calc from validVac non-seasonal.Rmd)
nBirths_df <- read_csv("output/Applied/stableAgeSex/Applied_nBirths_OC.csv")
imm_decay_corrected <- read_csv("data/imm_decay_bodjo_v2.csv") 

## Datasets
datasets <- fix_age_data_full %>% select(-parameter) %>% colnames()
#combine nBirths with other demogrpahics
var_demo_data_full <- var_demo_data_full %>%
  mutate(nBirths_yr = nBirths_df$mean)

```

```{r modSetup}

######################
## MODEL SETUP ##
######################

## Simulation:
TimeStop_dynamics <- 20*52 # 2 years only interested in rates for 1 y
TimeStop_transmission <- 24 # 1 day, hourly timestep for transmission component
min_pop <- 1 # set minimum size of population, if pop drops below then set to 0


##################
## RUN MODEL ##
##################

turnover <- F; 
dynamics <- T; 
transmission <- F; 
clean_environment <- T
seasonal <- T

# timepoints for population growth
t2 <- TimeStop_dynamics/2 # 5 year pop growth
t1 <- TimeStop_dynamics


##################################
## BIRTH PEAKS  ##
##################################

# id which week of the year each month starts on:
wkmnthids <- data.frame(
  mnth = 1:12,
  mnthwk = seq(1,53, by = 4.345) %>% round()
)

peakmnth <- 1  # Month of peak
peakstart <- wkmnthids %>% filter(mnth == peakmnth) %>% pull()
pkwk1 <- seq(from=peakstart, by=1, length.out=4)
birthpeak_w <- c()
time_yrs <- TimeStop_dynamics/52
for(i in 1:time_yrs-1){
  seqjump <- i*52
  pkwki <- pkwk1+seqjump
  birthpeak_w <- c(birthpeak_w,pkwki)
}

##################################
## LHS SETUP  ##
##################################

lhs <- F
lhs_n <- 0 # number of sets (parameter combinations)
pairs_plot <- F
SA <- F

```

Vaccination simulations:
- 4 rounds: year 1-2: >4m, year 3-4: 4m-12m
- coverages: 70,80,90,100
- schedules: annual, 6-monthly

Appendices:
- 3 rounds: year 1-2: >4m, year 3: 4m-12m
- lower minimum age of vaccination: 2y
- raise upper limit for vaccination in year 3-4: 16m
- schedules (annual, 6-monthly)

```{r vaccinationSchedule}

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pVs <-c(0.7,0.8,0.9,1)
pV <- 1
# source("scripts/applied/applied_vaccination.R")


## GSCE Vaccination: 

# vaccination starts at halfway point of simulation
V1 <- 0.5*TimeStop_dynamics # first vaccination campaign
V_rounds <- 4 # number of campaigns (GSCE recommended)
V_breaks <- 52 # timesteps between campaigns: 1 year gaps with 1 week timestep

V_starts <- vector(length=V_rounds)
for(v in 1:V_rounds){
  V_starts[v] <- V1+(v-1)*V_breaks
}

V_age_min <- round(4 *4.345,0) # 4 months (4.345 weeks per month)
V_age_max <- round(12*4.345,0) # 12 months (4.345 weeks per month) for partial campaigns

Vprog <- data.frame(
  Vround = 1:V_rounds,
  Vtype = c("full","full","partial", "partial"),
  Vweek = V_starts,
  Vmin = V_age_min,
  Vmax = c(NA, NA, V_age_max, V_age_max),
  pV = rep(pV, V_rounds)
)

Vstart <- Vprog %>% filter(Vround==1) %>% pull(Vweek)


```


# Simulate full immunity dynamics following vaccination for all OC profiles with non-seasonal reproduction

```{r DynLoop}

###################
## MODEL OUTPUT ##
###################
seasonal <- F
## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.nonseasonal <- list()

#####################
## DATA SELECTION ##
#####################

dataset <- datasets

if (dataset == "lesnoff.ft") {
  rates <- "wkly"
} else{
  rates <- "yrly"
}

fixdata <- dataset # set dataset for state_vars
vardata <- dataset
  
# filter to profiles with non-seasonal reproduction
var_demo_data_profs <- var_demo_data_full %>%
  filter(!prof %in% c("oc.goat.aridP",
                     "oc.goat.semiaridP",
                     "oc.shp.aridP",
                     "oc.shp.semiaridP"))

profOrder <- var_demo_data_profs %>% select(prof) %>% pull()
var_input_backup <- var_demo_data_profs %>% select(-prof)

```

```{r runMod}

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")

ocOut.nonseasonal.list <- c()

for(v in 1:length(pVs)){
  Vprog$pV <- pVs[v]
  
  ocOut.nonseasonal <- foreach (i = 1:nrow(var_input_backup),
                           .packages = c("dplyr", "tibble")) %dopar% {
                             print(i)
                             
                             var_input_full <- unlist(var_input_backup[i,])
                             
                             App_func(
                               imm_decay_corrected,
                               var_input_full,
                               fix_age_data_full,
                               f_list,
                               # initial state of female population
                               m_list,
                               # initial state of male population
                               TimeStop_dynamics,
                               # 1 year, weekly timestep for demographic component
                               TimeStop_transmission,
                               # 1 day, hourly timestep for transission component
                               output,
                               # model output: tracker or summary stats
                               summary_df,
                               #
                               clean_environment,
                               Vstart,
                               Vprog,
                               fixdata,
                               vardata,
                               birthpeak_w,
                               seasonal
                             )
                           }
  
  
  
  ocOut.nonseasonal.list[[v]] <- ocOut.nonseasonal 
}

stopCluster(cl)

```

```{r DynamicsSave}

# save csv to avoid rerunning full script

immDynamics.clean <- c() # dataframe for expanded immunity dynamics

for(l in 1:length(pVs)){
  dynamics_i <- ocOut.nonseasonal.list[[l]]
  
  immDynamics <- lapply(dynamics_i, select, prop_immune) %>%
  bind_cols() %>%
  t() %>%
  as.data.frame()
  
  colnames(immDynamics) <- 1:ncol(immDynamics)
  rownames(immDynamics) <- 1:nrow(immDynamics)
  
  immDynamics.clean <- immDynamics.clean %>% 
    bind_rows(
      immDynamics %>%
        select((t2):ncol(immDynamics)) %>%
        mutate(prof = profOrder,
               pV = pVs[l])
    )
    
}

filename_immDyn_nonseasonal12 <- "immDyn_nonseasonalV12.csv"
# write.csv(immDynamics.clean, file = paste0("output/Applied/", filename_immDyn_nonseasonal12))

```

```{r DynamicsAnalysis}
# Load data?
# immDynamics.clean <- read.csv("output/Applied/immDyn_nonseasonalV12.csv", row.names = F)

immDynamics.long <- immDynamics.clean %>%
  gather(key = "weeks", value = "prop_immune", -c(prof, pV)) %>%
  mutate(weeks = as.numeric(weeks)) %>%
  mutate(prof = gsub("oc.", "", prof)) %>%
  mutate(prof = factor(prof, levels = c("goat.semiaridM","goat.subhumidM","goat.humidM","shp.semiaridM", "shp.subhumidM","shp.humidM")))

# Calculate mean and confidence interval
summary_data <- immDynamics.long %>%
  group_by(pV,prof,weeks) %>%
  summarise(
    mean_value = mean(prop_immune),
    lower_ci = quantile(prop_immune, 0.025),
    upper_ci = quantile(prop_immune, 0.975)
  )

plot_immVar <- ggplot(summary_data, aes(x = weeks, y = mean_value)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = factor(pV)), alpha = 0.5) +
  geom_line(aes(col = factor(pV)), size = 0.7) +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~prof)+ 
  guides(fill = "none")+
  labs(x="Time (years)", y = "Flock proportion immune", col = "pV")+
  coord_cartesian(xlim = c(520,755))+
  scale_x_continuous(breaks = seq(520, 755, by = 26), labels = seq(520, 755, by = 26) / 52)+
  scale_colour_brewer(palette = "RdYlBu")+
  scale_fill_brewer(palette = "RdYlBu")

plot_immVar

plot_immVar.noUncertainty <- ggplot(summary_data, aes(x = weeks, y = mean_value)) +
  # geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = factor(pV)), alpha = 0.5) +
  geom_line(aes(col = factor(pV)), size = 0.7) +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~prof)+ 
  guides(fill = "none")+
  labs(x="Time (years)", y = "Flock proportion immune", col = "pV")+
  coord_cartesian(xlim = c(520,755))+
  scale_x_continuous(breaks = seq(520, 755, by = 26), labels = seq(520, 755, by = 26) / 52)+
  scale_colour_brewer(palette = "RdYlBu")+
  scale_fill_brewer(palette = "RdYlBu")

plot_immVar.noUncertainty

if(plotsave){
  filename_immVar <- "OC_nonseasonalDyn_V12m.png"
  ggsave(paste0("plots/applied/",filename_immVar), plot = plot_immVar, width = 20, height = 10, units = "cm")
  
  filename_immVarN <- "OC_nonseasonalDyn-noUncertainty_V12m.png"
  ggsave(paste0("plots/applied/",filename_immVarN), plot = plot_immVar.noUncertainty, width = 20, height = 10, units = "cm")
}
```


```{r runMod2}

seasonal <- F
## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.nonseasonalSumm <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")

ocOut.nonseasonalSumm.list <- c()


for(v in 1:length(pVs)){
  Vprog$pV <- pVs[v]
  
  summ_i <- foreach (i = 1:nrow(var_input_backup),
                           .packages = c("dplyr", "tibble"),
                           .combine = "rbind") %dopar% {
                             print(i)
                             
                             var_input_full <- unlist(var_input_backup[i,])
                             
                             App_func(
                               imm_decay_corrected,
                               var_input_full,
                               fix_age_data_full,
                               f_list,
                               # initial state of female population
                               m_list,
                               # initial state of male population
                               TimeStop_dynamics,
                               # 1 year, weekly timestep for demographic component
                               TimeStop_transmission,
                               # 1 day, hourly timestep for transission component
                               output,
                               # model output: tracker or summary stats
                               summary_df,
                               #
                               clean_environment,
                               Vstart,
                               Vprog,
                               fixdata,
                               vardata,
                               birthpeak_w,
                               seasonal
                             )
                           }

ocOut.nonseasonalSumm <- bind_rows(ocOut.nonseasonalSumm,
                                summ_i %>% mutate(pV = pVs[v],
                                                  prof = profOrder))
}

stopCluster(cl)

#  Start from here if not wanting to run the model:
# filename_immDyn_nonseasonalSumm12 <- "immDyn_nonseasonalSummV12.csv"
# write.csv(ocOut.nonseasonalSumm, file = paste0("output/Applied/", filename_immDyn_nonseasonalSumm12))

```

# Summary Stats
- Plots for: 
    - immunity at onset (V0)
    - immunity at 6m post-vac (imm_V6)
    - immunity at 12m post-vac (imm_V12)
    - weeks with immunity >=70% after round 1
    - total weeks with immunity >= 70% in 4 year period

```{r analysisSumm_V12}
# load data?
# ocOut.nonseasonalSumm <- read.csv("output/Applied/immDyn_nonseasonalSummV12.csv", row.names = F)


## Custom labeller function
custom_labeller <- function(variable, value) {
  label = paste(variable, "=", value)
  return(label)
}

ocOut.summdf <- ocOut.nonseasonalSumm %>%
  mutate(prof_group = ifelse(grepl("*shp*", prof), "shp", "goat"),
         prof = gsub("oc.", "", prof)) %>%
  mutate(prof = factor(prof, levels = c("goat.semiaridM","shp.semiaridM","goat.subhumidM", "shp.subhumidM","goat.humidM","shp.humidM")))

validImm <- ocOut.summdf %>%
  select(tenyr_growth, starts_with("imm"), pV, prof, prof_group) %>%
  gather(key = "stat", value = "value", -c(prof,prof_group, pV)) %>%
  mutate(stat = factor(stat, levels = c("imm_V0", "imm_6m", "imm_12m", "imm70_w", "imm70_wAll", "tenyr_growth" )))

plot_imm <- ggplot(validImm %>% filter(stat %in% c("imm_V0", "imm_6m", "imm_12m")), 
                   aes(x = prof, y = value, group = prof))+ 
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_grid(pV~stat)+
  ylim(0,1)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.position = "none")
plot_imm

plot_immV0 <- ggplot(validImm %>% filter(stat %in% c("imm_V0")),
                     aes(x = prof, y = value, group = prof)) +
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_hline(yintercept = 0.7, linetype = "dashed") +
  facet_wrap( ~ pV, nrow = 1, labeller = custom_labeller) +
  ylim(0,1)+
  labs(x="Flock profile", y="Flock proportion immune")+
  theme(axis.text.x = element_text(angle = 45,hjust = 1, vjust = 1), legend.position = "none")
plot_immV0

plot_imm70 <- ggplot(validImm %>% filter(stat %in% c("imm70_w")), aes(x = value, y = prof))+
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_vline(xintercept = 26, linetype = "dashed")+
  facet_wrap(~pV, labeller = custom_labeller, ncol = 1)+
  labs(x = "Weeks post-vaccination", y = "Flock profile", title = "1st campaign")
plot_imm70

plot_imm70All <- ggplot(validImm %>% filter(stat %in% c("imm70_wAll")), aes(x = value, y = prof))+ 
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_vline(xintercept = 26, linetype = "dashed")+
  facet_wrap(~pV, labeller = custom_labeller, ncol = 1)+
  labs(x = "Weeks post-vaccination", y = "Flock profile", title = "4-year period")
plot_imm70All

plot_imm70s <- ggarrange(plot_imm70, plot_imm70All, nrow = 1)

# plot_tenyr <- ggplot(validImm %>% filter(stat %in% c("tenyr_growth")), 
#             aes(x = prof, y = value))+ # , col = peakmnth
#   geom_boxplot(alpha = 0.5, fill = "grey") +
#   facet_grid(pV~stat, scales = "free")+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
#         legend.position = "none")
# plot_tenyr

filename_imm <- "OC_nonseasonalImm_V12m.png"
filename_immV0 <- "OC_nonseasonalImmV0_V12m.png"
filename_imm70 <- "OC_nonseasonalImm70_V12m.png"
filename_imm70All <- "OC_nonseasonalImm70All_V12m.png"
filename_imm70s <- "OC_nonseasonalImm70s_V12m.png"

if(plotsave){
  # ggsave(paste0("plots/applied/",filename_imm), plot = plot_imm, width = 10, height = 20, units = "cm")
  ggsave(paste0("plots/applied/",filename_immV0), plot = plot_immV0, width = 20, height = 10, units = "cm")
  # ggsave(paste0("plots/applied/",filename_imm70), plot = plot_imm70, width = 10, height = 10, units = "cm")
  # ggsave(paste0("plots/applied/",filename_imm70All), plot = plot_imm70All, width = 10, height = 10, units = "cm")
  ggsave(paste0("plots/applied/",filename_imm70s), plot = plot_imm70s, width = 20, height = 15, units = "cm")
}

####################
## PVIR70 Table ##
###################

validImm_summary <- validImm %>% group_by(stat, pV, prof) %>%
  summarise(mean = mean(value) %>% round(.,digits = 2),
            median = median(value) %>% round(.,digits = 2), 
            min = min(value) %>% round(.,digits = 2), 
            max = max(value) %>% round(.,digits = 2)
            ) %>%
  mutate(median_range = paste0(median," (",min,"-",max,")"))

pvir70_summary <- validImm_summary %>%
  mutate(mean = round(mean, digits = 0), 
         median = round(median, digits = 0), 
         min = round(min, digits = 0),
         max = round(max, digits = 0)) %>%
  filter(stat %in% c("imm70_w", "imm70_wAll")) %>%
  select(-c(median,min,max)) 

if(plotsave){
  write_csv(pvir70_summary, file = "tables/applied/nonseasonalV12_pvir70.csv")
}
```


#############################################
## 6 Month Vaccination
#############################################

```{r V6sched}

#######################
## Vaccination Setup ##
#######################
# see applied_vaccination
pVs <- c(0.7,0.8,0.9,1)
pV <- 1
# source("scripts/applied/applied_vaccination.R")


## GSCE Vaccination: 

# vaccination starts at halfway point of simulation
V1 <- 0.5*TimeStop_dynamics # first vaccination campaign
V_rounds <- 8 # number of campaigns (GSCE recommended)

## Update V_breaks to 26 (half a year)
V_breaks <- 26 # timesteps between campaigns: 1 year gaps with 1 week timestep

V_starts <- vector(length=V_rounds)
for(v in 1:V_rounds){
  V_starts[v] <- V1+(v-1)*V_breaks
}

V_age_min <- round(4 *4.345,0) # 4 months (4.345 weeks per month)
V_age_max <- round(12*4.345,0) # 12 months (4.345 weeks per month) for partial campaigns

Vprog6 <- data.frame(
  Vround = 1:V_rounds,
  Vtype = c(rep("full",4),rep("partial", 4)),
  Vweek = V_starts,
  Vmin = V_age_min,
  Vmax = c(rep(NA, 4), rep(V_age_max, 4)),
  pV = rep(pV, V_rounds)
)

Vstart <- Vprog6 %>% filter(Vround==1) %>% pull(Vweek)


```


```{r setupDyn_V6}

###################
## MODEL OUTPUT ##
###################
seasonal <- F
## Model Output
output <- "dynamics" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.nonseasonal6 <- list()

#####################
## DATA SELECTION ##
#####################

dataset <- datasets

if (dataset == "lesnoff.ft") {
  rates <- "wkly"
} else{
  rates <- "yrly"
}

fixdata <- dataset # set dataset for state_vars
vardata <- dataset
  
# filter to profiles with non-seasonal reproduction
var_demo_data_profs <- var_demo_data_full %>%
  filter(!prof %in% c("oc.goat.aridP",
                     "oc.goat.semiaridP",
                     "oc.shp.aridP",
                     "oc.shp.semiaridP"))

profOrder <- var_demo_data_profs %>% select(prof) %>% pull()
var_input_backup <- var_demo_data_profs %>% select(-prof)

```

```{r runModDyn_V6}

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")

ocOut.nonseasonal6.list <- c()
Vprog <- Vprog6
for(v in 1:length(pVs)){
  
  Vprog$pV <- pVs[v]
  
  ocOut.nonseasonal6 <- foreach (i = 1:nrow(var_input_backup),
                           .packages = c("dplyr", "tibble")) %dopar% {
                             print(i)
                             
                             var_input_full <- unlist(var_input_backup[i,])
                             
                             App_func(
                               imm_decay_corrected,
                               var_input_full,
                               fix_age_data_full,
                               f_list,
                               # initial state of female population
                               m_list,
                               # initial state of male population
                               TimeStop_dynamics,
                               # 1 year, weekly timestep for demographic component
                               TimeStop_transmission,
                               # 1 day, hourly timestep for transission component
                               output,
                               # model output: tracker or summary stats
                               summary_df,
                               #
                               clean_environment,
                               Vstart,
                               Vprog,
                               fixdata,
                               vardata,
                               birthpeak_w,
                               seasonal
                             )
                           }
  
  
  
  ocOut.nonseasonal6.list[[v]] <- ocOut.nonseasonal6 
}

stopCluster(cl)

```


```{r saveDyn_V6}

# save csv to avoid rerunning full script

immDynamics6.clean <- c() # dataframe for expanded immunity dynamics

for(l in 1:length(pVs)){
  dynamics6_i <- ocOut.nonseasonal6.list[[l]]
  
  immDynamics6 <- lapply(dynamics6_i, select, prop_immune) %>%
  bind_cols() %>%
  t() %>%
  as.data.frame()
  
  colnames(immDynamics6) <- 1:ncol(immDynamics6)
  rownames(immDynamics6) <- 1:nrow(immDynamics6)
  
  immDynamics6.clean <- immDynamics6.clean %>% 
    bind_rows(
      immDynamics6 %>%
        select((t2):ncol(immDynamics6)) %>%
        mutate(prof = profOrder,
               pV = pVs[l])
    )
    
}

filename_immDyn_nonseasonal6 <- "immDyn_nonseasonalV6.csv"
# write.csv(immDynamics6.clean, file = paste0("output/Applied/", filename_immDyn_nonseasonal6))

```

```{r analysisDyn_V6}
# Load data?
# immDynamics6.clean <- read_csv("output/Applied/immDyn_nonseasonalV6.csv") %>% select(-"...1")

immDynamics6.long <- immDynamics6.clean %>%
  gather(key = "weeks", value = "prop_immune", -c(prof, pV)) %>%
  mutate(weeks = as.numeric(weeks)) %>%
  mutate(prof = gsub("oc.", "", prof)) %>%
  mutate(prof = factor(prof, levels = c("goat.semiaridM","goat.subhumidM","goat.humidM","shp.semiaridM", "shp.subhumidM","shp.humidM")))

# Calculate mean and confidence interval
summary_data6 <- immDynamics6.long %>%
  group_by(pV,prof,weeks) %>%
  summarise(
    mean_value = mean(prop_immune),
    lower_ci = quantile(prop_immune, 0.025),
    upper_ci = quantile(prop_immune, 0.975)
  )

plot_immVar6 <- ggplot(summary_data6, aes(x = weeks, y = mean_value)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = factor(pV)), alpha = 0.5) +
  geom_line(aes(col = factor(pV)), size = 0.7) +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~prof)+ 
  guides(fill = "none")+
  labs(x="Time (years)", y = "Flock proportion immune", col = "pV")+
  coord_cartesian(xlim = c(520,755))+
  scale_x_continuous(breaks = seq(520, 755, by = 26), labels = seq(520, 755, by = 26) / 52)+
  scale_colour_brewer(palette = "RdYlBu")+
  scale_fill_brewer(palette = "RdYlBu")

plot_immVar6

plot_immVar6.noUncertainty <- ggplot(summary_data6, aes(x = weeks, y = mean_value)) +
  # geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = factor(pV)), alpha = 0.5) +
  geom_line(aes(col = factor(pV)), size = 0.7) +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_wrap(~prof)+ 
  guides(fill = "none")+
  labs(x="Time (years)", y = "Flock proportion immune", col = "pV")+
  coord_cartesian(xlim = c(520,755))+
  scale_x_continuous(breaks = seq(520, 755, by = 26), labels = seq(520, 755, by = 26) / 52)+
  scale_colour_brewer(palette = "RdYlBu")+
  scale_fill_brewer(palette = "RdYlBu")

plot_immVar6.noUncertainty

if(plotsave){
  filename_immVar6 <- "OC_nonseasonalDyn_V6m.png"
  ggsave(paste0("plots/applied/",filename_immVar6), plot = plot_immVar6, width = 20, height = 10, units = "cm")
  
  filename_immVarN6 <- "OC_nonseasonalDyn-noUncertainty_V6m.png"
  ggsave(paste0("plots/applied/",filename_immVarN6), plot = plot_immVar6.noUncertainty, width = 20, height = 10, units = "cm")
}

```


```{r modSumm_V6}

seasonal <- F
## Model Output
output <- "summary_all" # Output options: "summary" (stats with age-group prop), "summary_all" (stats with age-sex group prop), "dynamics" (pop metrics over time)
# create empty dataframe to store output
summary_df <- output_func(TimeStop_dynamics, output) 

# validOut = list to store outputs
GSAoutput <- c(); 
ocOut.nonseasonal6Summ <- list()

#####################
## PARALLELISATION ##
#####################

print("start-parallel")

## Local parallelisation
if(local){
  cores=detectCores()
  cl <- makeCluster(cores[1]-1)
  registerDoParallel(cl)
}else{
  cores=detectCores()
  cl <- makeCluster(10)
  registerDoParallel(cl)
}
print("parallel-verified")
print("start-model")

ocOut.nonseasonal6Summ.list <- c()


for(v in 1:length(pVs)){
  Vprog$pV <- pVs[v]
  
  summ_i <- foreach (i = 1:nrow(var_input_backup),
                           .packages = c("dplyr", "tibble"),
                           .combine = "rbind") %dopar% {
                             print(i)
                             
                             var_input_full <- unlist(var_input_backup[i,])
                             
                             App_func(
                               imm_decay_corrected,
                               var_input_full,
                               fix_age_data_full,
                               f_list,
                               # initial state of female population
                               m_list,
                               # initial state of male population
                               TimeStop_dynamics,
                               # 1 year, weekly timestep for demographic component
                               TimeStop_transmission,
                               # 1 day, hourly timestep for transission component
                               output,
                               # model output: tracker or summary stats
                               summary_df,
                               #
                               clean_environment,
                               Vstart,
                               Vprog,
                               fixdata,
                               vardata,
                               birthpeak_w,
                               seasonal
                             )
                           }

ocOut.nonseasonal6Summ <- bind_rows(ocOut.nonseasonal6Summ,
                                summ_i %>% mutate(pV = pVs[v],
                                                  prof = profOrder))
}


stopCluster(cl)


#  Start from here if not wanting to run the model:
# filename_immDyn_nonseasonal6Summ <- "immDyn_nonseasonalSummV6.csv"
# write.csv(ocOut.nonseasonal6Summ, file = paste0("output/Applied/", filename_immDyn_nonseasonal6Summ))

```


# Summary Stats
- Plots for: 
    - immunity at onset (V0)
    - immunity at 6m post-vac (imm_V6)
    - immunity at 12m post-vac (imm_V12)
    - weeks with immunity >=70% after round 1
    - total weeks with immunity >= 70% in 4 year period

```{r analysisSumm_V6}
# load data?
# ocOut.nonseasonal6Summ <- read.csv("output/Applied/immDyn_nonseasonalSummV6.csv", row.names = F)

ocOut6.summdf <- ocOut.nonseasonal6Summ %>%
  mutate(prof_group = ifelse(grepl("*shp*", prof), "shp", "goat"),
         prof = gsub("oc.", "", prof)) %>%
  mutate(prof = factor(prof, levels = c("goat.semiaridM","shp.semiaridM","goat.subhumidM", "shp.subhumidM","goat.humidM","shp.humidM")))

validImm6 <- ocOut6.summdf %>%
  select(tenyr_growth, starts_with("imm"), pV, prof, prof_group) %>%
  gather(key = "stat", value = "value", -c(prof,prof_group, pV)) %>%
  mutate(stat = factor(stat, levels = c("imm_V0", "imm_6m", "imm_12m", "imm70_w", "imm70_wAll", "tenyr_growth" )))

plot_imm6 <- ggplot(validImm6 %>% filter(stat %in% c("imm_V0", "imm_6m", "imm_12m")), 
                   aes(x = prof, y = value, group = prof))+ 
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_hline(yintercept = 0.7, linetype = "dashed")+
  facet_grid(pV~stat)+
  ylim(0,1)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
          legend.position = "none")
plot_imm6

plot_imm6V0 <- ggplot(validImm6 %>% filter(stat %in% c("imm_V0")),
                     aes(x = prof, y = value, group = prof)) +
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_hline(yintercept = 0.7, linetype = "dashed") +
  facet_wrap( ~ pV, nrow = 1, labeller = custom_labeller) +
  ylim(0,1)+
  labs(x="Flock profile", y="Flock proportion immune")+
  theme(axis.text.x = element_text(angle = 45,hjust = 1, vjust = 1), legend.position = "none")
plot_imm6V0

plot_imm6.70 <- ggplot(validImm6 %>% filter(stat %in% c("imm70_w")), aes(x = value, y = prof))+
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_vline(xintercept = 26, linetype = "dashed")+
  facet_wrap(~pV, labeller = custom_labeller, ncol = 1)+
  labs(x = "Weeks post-vaccination", y = "Flock profile", title = "1st campaign")+
  coord_cartesian(xlim=c(0,55))
plot_imm6.70

plot_imm6.70All <- ggplot(validImm6 %>% filter(stat %in% c("imm70_wAll")), aes(x = value, y = prof))+ 
  geom_boxplot(alpha = 0.5, fill = "grey") +
  geom_vline(xintercept = 26, linetype = "dashed")+
  facet_wrap(~pV, labeller = custom_labeller, ncol = 1)+
  labs(x = "Weeks post-vaccination", y = "Flock profile", title = "4-year period")+
  coord_cartesian(xlim = c(0,210))
plot_imm6.70All

plot_imm6.70s <- ggarrange(plot_imm6.70, plot_imm6.70All, nrow = 1)


# plot_tenyr <- ggplot(validImm %>% filter(stat %in% c("tenyr_growth")), 
#             aes(x = prof, y = value))+ # , col = peakmnth
#   geom_boxplot(alpha = 0.5, fill = "grey") +
#   facet_grid(pV~stat, scales = "free")+
#   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
#         legend.position = "none")
# plot_tenyr


filename_imm6 <- "OC_nonseasonalImm_V6m.png"
filename_imm6V0 <- "OC_nonseasonalImmV0_V6m.png"
filename_imm6.70 <- "OC_nonseasonalImm70_V6m.png"
filename_imm6.70All <- "OC_nonseasonalImm70All_V6m.png"
filename_imm6.70s <- "OC_nonseasonalImm70s_V6m.png"

if(plotsave){
  #ggsave(paste0("plots/applied/",filename_imm6), plot = plot_imm6, width = 10, height = 20, units = "cm")
  ggsave(paste0("plots/applied/",filename_imm6V0), plot = plot_imm6V0, width = 20, height = 10, units = "cm")
  #ggsave(paste0("plots/applied/",filename_imm6.70), plot = plot_imm6.70, width = 10, height = 10, units = "cm")
  #ggsave(paste0("plots/applied/",filename_imm6.70All), plot = plot_imm6.70All, width = 10, height = 10, units = "cm")
  ggsave(paste0("plots/applied/",filename_imm6.70s), plot = plot_imm6.70s, width = 20, height = 15, units = "cm")
  
}


####################
## PVIR70 Table ##
###################

validImm6_summary <- validImm6 %>% group_by(stat, pV, prof) %>%
  summarise(mean = mean(value) %>% round(.,digits = 2),
            median = median(value) %>% round(.,digits = 2), 
            min = min(value) %>% round(.,digits = 2), 
            max = max(value) %>% round(.,digits = 2)
            ) %>%
  mutate(median_range = paste0(median," (",min,"-",max,")"))

pvir70_summary6 <- validImm6_summary %>%
  mutate(mean = round(mean, digits = 0), 
         median = round(median, digits = 0), 
         min = round(min, digits = 0),
         max = round(max, digits = 0)) %>%
  filter(stat %in% c("imm70_w", "imm70_wAll")) %>%
  select(-c(median,min,max))

if(plotsave){
  write_csv(pvir70_summary6, file = "tables/applied/nonseasonalV6_pvir70.csv")
}

```